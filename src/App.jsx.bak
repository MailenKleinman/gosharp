import React, { useState, useEffect } from 'react';
import './App.css';
import { Box, AppBar, Toolbar, Typography, Container, Paper, Grid, ThemeProvider, createTheme, CssBaseline, Breadcrumbs, Link, Tabs, Tab, Button, Tooltip, TextField, Menu, MenuItem, Switch, FormControlLabel, RadioGroup, Radio, FormControl, Dialog, DialogTitle, DialogContent, DialogActions, Select, Divider, Card, Checkbox } from '@mui/material';
import { DataGrid } from '@mui/x-data-grid';
import { Edit as EditIcon, Visibility as VisibilityIcon, PhoneIphone as PhoneIphoneIcon, History as HistoryIcon, Settings as SettingsIcon, ExpandMore as ExpandMoreIcon, Search as SearchIcon } from '@mui/icons-material';
import { TextFields as TextFieldsIcon, CheckBox as CheckboxIcon, RadioButtonChecked as RadioButtonCheckedIcon, Image as ImageIcon, ThumbsUpDown as ThumbsUpDownIcon, ToggleOff as ToggleOffIcon, List as ListIcon, CalendarMonth as CalendarMonthIcon, Numbers as NumbersIcon, Assignment as AssignmentIcon, Star as StarIcon, SwapVert as SwapVertIcon } from '@mui/icons-material';
import { Person as PersonIcon, Add as AddIcon, Close as CloseIcon, Email as EmailIcon, Phone as PhoneIcon, LocationOn as LocationOnIcon, Language as LanguageIcon } from '@mui/icons-material';
import { FormatListBulleted as FormatListBulletedIcon, Title as TitleIcon, FileUpload as FileUploadIcon, FileDownload as FileDownloadIcon, ArrowDownward as ArrowDownwardIcon, DragIndicator as DragIndicatorIcon } from '@mui/icons-material';
import { Delete as DeleteIcon, DeleteOutline as DeleteOutlineIcon, ContentCopy as ContentCopyIcon, AutoFixHigh as AutoFixHighIcon, MoreVert as MoreVertIcon } from '@mui/icons-material';
import { FormatColorText as FormatColorTextIcon, FormatBold as FormatBoldIcon, FormatItalic as FormatItalicIcon, FormatUnderlined as FormatUnderlinedIcon, FormatListNumbered as FormatListNumberedIcon, Link as LinkIcon } from '@mui/icons-material';
import { useSelector, useDispatch } from 'react-redux';
import { fetchForms, createForm, updateForm, deleteForm, setSelectedForm } from './store/slices/formEditorSlice';


const theme = createTheme({
  palette: {
    primary: {
      main: '#047857',
    },
    background: {
      default: '#ffffff',
    },
  },
  typography: {
    fontFamily: 'Montserrat, Arial, sans-serif',
  },
});

function App() {

  const dispatch = useDispatch();

  const [selectedTab, setSelectedTab] = useState(1);
  const [leftWidth, setLeftWidth] = useState(20); // percentage
  const [rightWidth, setRightWidth] = useState(20); // percentage
  const [isDragging, setIsDragging] = useState(null);
  const [breadcrumbTitle, setBreadcrumbTitle] = useState('My tool test');
  const [isEditingBreadcrumb, setIsEditingBreadcrumb] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [dropdownAnchor, setDropdownAnchor] = useState(null);
  const [selectedComponent, setSelectedComponent] = useState('Multiple Choice');
  const [editingTabId, setEditingTabId] = useState(null);
  const [editingTabName, setEditingTabName] = useState('');
  const [tabMenuAnchor, setTabMenuAnchor] = useState(null);
  const [tabMenuTabId, setTabMenuTabId] = useState(null);
  const [draggedTabId, setDraggedTabId] = useState(null);
  const [dragOverTabId, setDragOverTabId] = useState(null);
  const [multipleChoiceSettings, setMultipleChoiceSettings] = useState({
    required: false,
    multipleSelection: false,
    randomize: false,
    otherOption: false
  });
  const [openPreviewModal, setOpenPreviewModal] = useState(false);
  const [openVersionHistoryModal, setOpenVersionHistoryModal] = useState(false);
  const [openImportModal, setOpenImportModal] = useState(false);
  const [openExportModal, setOpenExportModal] = useState(false);
  const [openPublishModal, setOpenPublishModal] = useState(false);
  const [openConditionalLogicModal, setOpenConditionalLogicModal] = useState(false);
  const [openChatToCreateModal, setOpenChatToCreateModal] = useState(false);
  const [showQuestionButtons, setShowQuestionButtons] = useState(false);
  const [versionTitles, setVersionTitles] = useState({
    version1: 'V3 adittion of notes',
    version2: 'Autosaved version',
    version3: 'Autosaved version'
  });
  const [sectionTitle, setSectionTitle] = useState('Add description');
  const [sectionDescription, setSectionDescription] = useState('Add detailed description');
  const [sectionTitleBold, setSectionTitleBold] = useState(false);
  const [sectionTitleItalic, setSectionTitleItalic] = useState(false);
  const [sectionDescBold, setSectionDescBold] = useState(false);
  const [sectionDescItalic, setSectionDescItalic] = useState(false);
  const [selectedNumber, setSelectedNumber] = useState(null);
  const [multipleChoiceOption1, setMultipleChoiceOption1] = useState('Option 1');
  const [multipleChoiceOption2, setMultipleChoiceOption2] = useState('Option 2');
  const [multipleChoiceOption3, setMultipleChoiceOption3] = useState('Add option...');
  const [selectedCard, setSelectedCard] = useState(null); // 1 for Header, 2 for Multiple Choice, 3 for Opinion Scale
  const [collapsedCards, setCollapsedCards] = useState({ 1: true, 2: true, 3: true }); // Track which cards are collapsed (default: all collapsed)
  const [collapsedSubcomponents, setCollapsedSubcomponents] = useState({}); // Track which subcomponents are collapsed
  const [selectedSubcomponents, setSelectedSubcomponents] = useState({}); // Track which subcomponents are selected
  const [draggedComponent, setDraggedComponent] = useState(null);
  const [isDragOver, setIsDragOver] = useState(false);
  const [draggedCard, setDraggedCard] = useState(null);
  const [dragOverCard, setDragOverCard] = useState(null);
  const [showFormatButtons, setShowFormatButtons] = useState(null);
  const [sectionTitleUnderline, setSectionTitleUnderline] = useState(false);
  const [sectionTitleBulletList, setSectionTitleBulletList] = useState(false);
  const [sectionTitleNumberedList, setSectionTitleNumberedList] = useState(false);
  const [sectionTitleLink, setSectionTitleLink] = useState(false);
  const [sectionDescUnderline, setSectionDescUnderline] = useState(false);
  const [sectionDescBulletList, setSectionDescBulletList] = useState(false);
  const [sectionDescNumberedList, setSectionDescNumberedList] = useState(false);
  const [sectionDescLink, setSectionDescLink] = useState(false);
  const [multipleChoiceOption1Bold, setMultipleChoiceOption1Bold] = useState(false);
  const [multipleChoiceOption1Italic, setMultipleChoiceOption1Italic] = useState(false);
  const [multipleChoiceOption1Underline, setMultipleChoiceOption1Underline] = useState(false);
  const [multipleChoiceOption2Bold, setMultipleChoiceOption2Bold] = useState(false);
  const [multipleChoiceOption2Italic, setMultipleChoiceOption2Italic] = useState(false);
  const [multipleChoiceOption2Underline, setMultipleChoiceOption2Underline] = useState(false);
  const [multipleChoiceOption3Bold, setMultipleChoiceOption3Bold] = useState(false);
  const [multipleChoiceOption3Italic, setMultipleChoiceOption3Italic] = useState(false);
  const [multipleChoiceOption3Underline, setMultipleChoiceOption3Underline] = useState(false);
  const [subcomponents, setSubquestions] = useState([]);
  const [subcomponents3, setSubquestions3] = useState([]);
  const [selectedSubquestion, setSelectedSubquestion] = useState(null);
  const [subcomponentSettings, setSubquestionSettings] = useState({});
  const [showConditionalLogic, setShowConditionalLogic] = useState({});
  const [conditionalLogic, setConditionalLogic] = useState({});

  const handleComponentDragStart = (componentType) => {
    setDraggedComponent(componentType);
  };

  const handleContentDragOver = (e) => {
    e.preventDefault();
    setIsDragOver(true);
  };

  const handleContentDragLeave = () => {
    setIsDragOver(false);
  };

  const handleContentDrop = (e) => {
    e.preventDefault();
    setIsDragOver(false);
    if (draggedComponent) {
      console.log('Dropped component:', draggedComponent);
      // Add new component to the form
      // This can be expanded to create actual components based on the dragged type
    }
    setDraggedComponent(null);
  };

  const handleTabDoubleClick = (tabId, tabLabel) => {
    setEditingTabId(tabId);
    setEditingTabName(tabLabel);
  };

  const handleTabNameChange = (newName) => {
    if (newName.trim() !== '') {
      const updatedTabs = tabs.map(tab =>
        tab.id === editingTabId ? { ...tab, label: newName } : tab
      );
      setTabs(updatedTabs);
    }
    setEditingTabId(null);
    setEditingTabName('');
  };

  const handleTabMenuClose = () => {
    setTabMenuAnchor(null);
    setTabMenuTabId(null);
  };

  const handleAddSubquestion = () => {
    const newSubquestionId = Date.now();
    const newSubquestion = {
      id: newSubquestionId,
      type: 'Short Text',
      title: `Subquestion ${subcomponents.length + 1}`,
      required: false,
      text: ''
    };
    setSubquestions([...subcomponents, newSubquestion]);
    setCollapsedSubcomponents({ ...collapsedSubcomponents, [newSubquestionId]: true });
  };

  const handleAddSubquestion3 = () => {
    const newSubquestionId = Date.now();
    const newSubquestion = {
      id: newSubquestionId,
      type: 'Short Text',
      title: `Subquestion ${subcomponents3.length + 1}`,
      required: false,
      text: ''
    };
    setSubquestions3([...subcomponents3, newSubquestion]);
    setCollapsedSubcomponents({ ...collapsedSubcomponents, [newSubquestionId]: true });
  };

  const handleUpdateSubquestionType = (id, newType) => {
    setSubquestions(subcomponents.map(sub =>
      sub.id === id ? { ...sub, type: newType } : sub
    ));
  };

  const handleUpdateSubquestionType3 = (id, newType) => {
    setSubquestions3(subcomponents3.map(sub =>
      sub.id === id ? { ...sub, type: newType } : sub
    ));
  };

  const handleUpdateSubquestionRequired = (id, required) => {
    setSubquestions(subcomponents.map(sub =>
      sub.id === id ? { ...sub, required } : sub
    ));
  };

  const handleUpdateSubquestionRequired3 = (id, required) => {
    setSubquestions3(subcomponents3.map(sub =>
      sub.id === id ? { ...sub, required } : sub
    ));
  };

  const handleUpdateSubquestionText = (id, text, isCard2 = true) => {
    if (isCard2) {
      setSubquestions(subcomponents.map(sub =>
        sub.id === id ? { ...sub, text } : sub
      ));
    } else {
      setSubquestions3(subcomponents3.map(sub =>
        sub.id === id ? { ...sub, text } : sub
      ));
    }
  };

  const getComponentIcon = (componentName) => {
    const iconProps = { sx: { fontSize: '32px', color: '#8c8c8c' } };
    switch (componentName) {
      case 'Header':
        return <TitleIcon {...iconProps} />;
      case 'Long Text':
      case 'Short Text':
        return <TextFieldsIcon {...iconProps} />;
      case 'Multiple Choice':
        return <RadioButtonCheckedIcon {...iconProps} />;
      case 'Dropdown':
        return <ListIcon {...iconProps} />;
      case 'Picture Choice':
        return <ImageIcon {...iconProps} />;
      case 'Yes/No':
        return <ThumbsUpDownIcon {...iconProps} />;
      case 'Checkbox':
        return <CheckboxIcon {...iconProps} />;
      case 'Number':
        return <NumbersIcon {...iconProps} />;
      case 'Date':
        return <CalendarMonthIcon {...iconProps} />;
      case 'Opinion Scale':
        return <AssignmentIcon {...iconProps} />;
      case 'Rating':
        return <StarIcon {...iconProps} />;
      case 'Ranking':
        return <SwapVertIcon {...iconProps} />;
      default:
        return null;
    }
  };

  const getSelectedCardComponentName = () => {
    switch (selectedCard) {
      case 1:
        return 'Header';
      case 2:
        return 'Multiple Choice';
      case 3:
        return 'Opinion Scale';
      default:
        return 'Header';
    }
  };

  const handleMouseDown = (divider) => {
    setIsDragging(divider);
  };

  const handleMouseUp = () => {
    setIsDragging(null);
  };

  const handleMouseMove = (e) => {
    if (!isDragging) return;

    const container = document.querySelector('[data-flex-container]');
    if (!container) return;

    const containerRect = container.getBoundingClientRect();
    const moveX = e.clientX - containerRect.left;
    const containerWidth = containerRect.width;
    const percentage = (moveX / containerWidth) * 100;

    if (isDragging === 'left') {
      const newLeftWidth = Math.max(10, Math.min(40, percentage));
      setLeftWidth(newLeftWidth);
    } else if (isDragging === 'right') {
      const newRightWidth = Math.max(10, Math.min(40, 100 - percentage));
      setRightWidth(newRightWidth);
    }
  };



  const selectedForm = useSelector((state) => state.formEditor.selectedForm);

  const TopNavbar = () => {
    return <AppBar position="fixed" sx={{ backgroundColor: '#f9fafb', boxShadow: 1 }}>
      <Toolbar sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <img src="/logo.png" alt="Logo" style={{ height: '50px' }} />

        {/* Navigation Buttons */}
        <Box sx={{ display: 'flex', gap: 3 }}>
          <Button
            sx={{
              color: '#374151',
              textTransform: 'none',
              fontSize: '14px',
              fontWeight: 500,
              '&:hover': {
                backgroundColor: 'transparent',
                color: '#047857'
              }
            }}
          >
            Dashboard
          </Button>

          <Button
            sx={{
              color: '#374151',
              textTransform: 'none',
              fontSize: '14px',
              fontWeight: 500,
              display: 'flex',
              alignItems: 'center',
              gap: 0.5,
              '&:hover': {
                backgroundColor: 'transparent',
                color: '#047857'
              }
            }}
          >
            Reports
            <ExpandMoreIcon sx={{ fontSize: '20px' }} />
          </Button>

          <Button
            sx={{
              color: '#047857',
              textTransform: 'none',
              fontSize: '14px',
              fontWeight: 500,
              '&:hover': {
                backgroundColor: 'transparent',
                color: '#047857'
              }
            }}
          >
            Setup
          </Button>

          <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
            <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end' }}>
              <Button
                sx={{
                  color: '#374151',
                  textTransform: 'none',
                  fontSize: '14px',
                  fontWeight: 500,
                  padding: 0,
                  minWidth: 'auto',
                  '&:hover': {
                    backgroundColor: 'transparent',
                    color: '#047857'
                  }
                }}
              >
                Name and Lastname
              </Button>
              <Typography sx={{ fontSize: '11px', color: '#047857', marginTop: '-4px' }}>
                Super Admin
              </Typography>
            </Box>
            <ExpandMoreIcon sx={{ fontSize: '18px', color: '#374151' }} />
          </Box>
        </Box>
      </Toolbar>
    </AppBar>
  };

  const SideBar = () => {
    return <Box sx={{ width: '15%', flexShrink: 0 }} />;
  };

  const FormEditor = () => {

    const PreviewModal = () => {
      return <Dialog open={openPreviewModal} onClose={() => setOpenPreviewModal(false)} maxWidth="lg" fullWidth sx={{ '& .MuiDialog-paper': { minHeight: '600px', display: 'flex', flexDirection: 'column', borderRadius: '10px' } }}>
        <DialogTitle sx={{ fontWeight: 600, color: '#111827', margin: 1, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          PREVIEW
          <Button
            onClick={() => setOpenPreviewModal(false)}
            sx={{
              minWidth: 'auto',
              padding: '4px',
              color: '#6b7280',
              '&:hover': {
                backgroundColor: 'rgba(0, 0, 0, 0.04)'
              }
            }}
          >
            <CloseIcon sx={{ fontSize: '20px' }} />
          </Button>
        </DialogTitle>
        <Divider sx={{ margin: 0 }} />
        <DialogContent sx={{ display: 'flex', flexDirection: 'column', gap: 0, padding: 0 }}>
          <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '36px', flex: 1 }}>
            {/* Preview Image Placeholder */}
            <Box sx={{
              backgroundColor: '#f3f4f6',
              border: '2px dashed #d1d5db',
              borderRadius: '8px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              width: '100%',
              height: '100%',
              minHeight: '400px',
              flexDirection: 'column',
              gap: 2
            }}>
              <ImageIcon sx={{ fontSize: '100px', color: '#9ca3af' }} />
              <Typography sx={{ fontSize: '16px', color: '#9ca3af', fontWeight: 500 }}>Preview</Typography>
            </Box>
          </Box>
        </DialogContent>
      </Dialog>
    };

    const VersionHistoryModal = () => {
      return <Dialog open={openVersionHistoryModal} onClose={() => setOpenVersionHistoryModal(false)} maxWidth="sm" fullWidth sx={{ '& .MuiDialog-paper': { display: 'flex', flexDirection: 'column', borderRadius: '10px' } }}>
        <DialogTitle sx={{ fontWeight: 600, color: '#111827', margin: 1, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          VERSION HISTORY
          <Button
            onClick={() => setOpenVersionHistoryModal(false)}
            sx={{
              minWidth: 'auto',
              padding: '4px',
              color: '#6b7280',
              '&:hover': {
                backgroundColor: 'rgba(0, 0, 0, 0.04)'
              }
            }}
          >
            <CloseIcon sx={{ fontSize: '20px' }} />
          </Button>
        </DialogTitle>
        <Divider sx={{ margin: 0 }} />
        <DialogContent sx={{ display: 'flex', flexDirection: 'column', gap: 0, padding: 0 }}>
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, padding: '36px' }}>
            {/* Version 1 */}
            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingBottom: 2, borderBottom: '1px solid #e5e7eb', gap: 2 }}>
              <Box sx={{ flex: 1 }}>
                <TextField
                  fullWidth
                  value={versionTitles.version1}
                  onChange={(e) => setVersionTitles({ ...versionTitles, version1: e.target.value })}
                  variant="standard"
                  sx={{ fontSize: '14px', fontWeight: 500, marginBottom: 1, '& .MuiInput-input': { fontSize: '14px', fontWeight: 500, color: '#111827' } }}
                />
                <Typography sx={{ fontSize: '12px', color: '#6b7280' }}>Nov 7, 2025 at 2:45 PM by Sarah Johnson</Typography>
              </Box>
              <Box sx={{ display: 'flex', gap: 1 }}>
                <Button
                  size="small"
                  variant="outlined"
                  sx={{
                    textTransform: 'none',
                    borderColor: '#d1d5db',
                    color: '#374151',
                    fontSize: '12px',
                    fontWeight: 500
                  }}
                >
                  Preview
                </Button>
                <Button
                  size="small"
                  variant="contained"
                  sx={{
                    textTransform: 'none',
                    backgroundColor: '#047857',
                    color: '#ffffff',
                    fontSize: '12px',
                    fontWeight: 500,
                    '&:hover': {
                      backgroundColor: '#065f46'
                    }
                  }}
                >
                  Restore
                </Button>
              </Box>
            </Box>

            {/* Version 2 */}
            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingBottom: 2, borderBottom: '1px solid #e5e7eb', gap: 2 }}>
              <Box sx={{ flex: 1 }}>
                <TextField
                  fullWidth
                  value={versionTitles.version2}
                  onChange={(e) => setVersionTitles({ ...versionTitles, version2: e.target.value })}
                  variant="standard"
                  sx={{ fontSize: '14px', fontWeight: 500, marginBottom: 1, '& .MuiInput-input': { fontSize: '14px', fontWeight: 500, color: '#111827' } }}
                />
                <Typography sx={{ fontSize: '12px', color: '#6b7280' }}>Nov 7, 2025 at 2:30 PM by Michael Chen</Typography>
              </Box>
              <Box sx={{ display: 'flex', gap: 1 }}>
                <Button
                  size="small"
                  variant="outlined"
                  sx={{
                    textTransform: 'none',
                    borderColor: '#d1d5db',
                    color: '#374151',
                    fontSize: '12px',
                    fontWeight: 500
                  }}
                >
                  Preview
                </Button>
                <Button
                  size="small"
                  variant="contained"
                  sx={{
                    textTransform: 'none',
                    backgroundColor: '#047857',
                    color: '#ffffff',
                    fontSize: '12px',
                    fontWeight: 500,
                    '&:hover': {
                      backgroundColor: '#065f46'
                    }
                  }}
                >
                  Restore
                </Button>
              </Box>
            </Box>

            {/* Version 3 */}
            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: 2 }}>
              <Box sx={{ flex: 1 }}>
                <TextField
                  fullWidth
                  value={versionTitles.version3}
                  onChange={(e) => setVersionTitles({ ...versionTitles, version3: e.target.value })}
                  variant="standard"
                  sx={{ fontSize: '14px', fontWeight: 500, marginBottom: 1, '& .MuiInput-input': { fontSize: '14px', fontWeight: 500, color: '#111827' } }}
                />
                <Typography sx={{ fontSize: '12px', color: '#6b7280' }}>Nov 7, 2025 at 2:15 PM by Emma Rodriguez</Typography>
              </Box>
              <Box sx={{ display: 'flex', gap: 1 }}>
                <Button
                  size="small"
                  variant="outlined"
                  sx={{
                    textTransform: 'none',
                    borderColor: '#d1d5db',
                    color: '#374151',
                    fontSize: '12px',
                    fontWeight: 500
                  }}
                >
                  Preview
                </Button>
                <Button
                  size="small"
                  variant="contained"
                  sx={{
                    textTransform: 'none',
                    backgroundColor: '#047857',
                    color: '#ffffff',
                    fontSize: '12px',
                    fontWeight: 500,
                    '&:hover': {
                      backgroundColor: '#065f46'
                    }
                  }}
                >
                  Restore
                </Button>
              </Box>
            </Box>
          </Box>
        </DialogContent>
      </Dialog>
    };

    const ImportModal = () => {
      return <Dialog open={openImportModal} onClose={() => setOpenImportModal(false)} maxWidth="lg" fullWidth sx={{ '& .MuiDialog-paper': { display: 'flex', flexDirection: 'column', borderRadius: '10px' } }}>
        <DialogTitle sx={{ fontWeight: 600, color: '#111827', margin: 1, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          IMPORT
          <Button
            onClick={() => setOpenImportModal(false)}
            sx={{
              minWidth: 'auto',
              padding: '4px',
              color: '#6b7280',
              '&:hover': {
                backgroundColor: 'rgba(0, 0, 0, 0.04)'
              }
            }}
          >
            <CloseIcon sx={{ fontSize: '20px' }} />
          </Button>
        </DialogTitle>
        <Divider sx={{ margin: 0 }} />

        <DialogContent sx={{ display: 'flex', flexDirection: 'column', gap: 0, padding: 0 }}>
          <Box sx={{ display: 'flex', gap: 2, padding: '36px' }}>
            {/* Left side - Dropdowns */}
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5, flex: 0.6, minWidth: '200px' }}>
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
                <Select
                  size="small"
                  defaultValue="tool"
                  sx={{ fontSize: '14px' }}
                  displayEmpty
                >
                  <MenuItem value="tool">Select Tool</MenuItem>
                  <MenuItem value="tool1">Tool 1</MenuItem>
                  <MenuItem value="tool2">Tool 2</MenuItem>
                  <MenuItem value="tool3">Tool 3</MenuItem>
                </Select>
              </Box>

              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
                <Select
                  size="small"
                  defaultValue="section"
                  sx={{ fontSize: '14px' }}
                  displayEmpty
                >
                  <MenuItem value="section">Select Section (optional)</MenuItem>
                  <MenuItem value="section1">Section 1</MenuItem>
                  <MenuItem value="section2">Section 2</MenuItem>
                  <MenuItem value="section3">Section 3</MenuItem>
                </Select>
              </Box>

              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
                <Select
                  size="small"
                  defaultValue="question"
                  sx={{ fontSize: '14px' }}
                  displayEmpty
                >
                  <MenuItem value="question">Select Question (optional)</MenuItem>
                  <MenuItem value="question1">Question 1</MenuItem>
                  <MenuItem value="question2">Question 2</MenuItem>
                  <MenuItem value="question2">Question 3</MenuItem>
                </Select>
              </Box>
            </Box>

            {/* Right side - Preview Image Placeholder */}
            <Box sx={{
              flex: 1.2,
              backgroundColor: '#f3f4f6',
              border: '2px dashed #d1d5db',
              borderRadius: '8px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              minHeight: '350px',
              flexDirection: 'column',
              gap: 2
            }}>
              <ImageIcon sx={{ fontSize: '80px', color: '#9ca3af' }} />
              <Typography sx={{ fontSize: '14px', color: '#9ca3af', fontWeight: 500 }}>Preview</Typography>
            </Box>
          </Box>

          <Divider sx={{ margin: 0 }} />

          <Box sx={{ display: 'flex', gap: 1, padding: '36px' }}>
            <Button
              size="small"
              variant="outlined"
              sx={{
                flex: 1,
                textTransform: 'none',
                borderColor: '#d1d5db',
                color: '#374151',
                fontSize: '14px',
                fontWeight: 500
              }}
            >
              Import Complete Tool
            </Button>
            <Button
              size="small"
              variant="outlined"
              sx={{
                flex: 1,
                textTransform: 'none',
                borderColor: '#d1d5db',
                color: '#374151',
                fontSize: '14px',
                fontWeight: 500
              }}
            >
              Import Complete Section
            </Button>
            <Button
              size="small"
              variant="contained"
              sx={{
                flex: 1,
                textTransform: 'none',
                backgroundColor: '#047857',
                color: '#ffffff',
                fontSize: '14px',
                fontWeight: 500,
                '&:hover': {
                  backgroundColor: '#065f46'
                }
              }}
            >
              Import Question
            </Button>
          </Box>
        </DialogContent>
      </Dialog>
    };

    const ExportModal = () => {
      return <Dialog open={openExportModal} onClose={() => setOpenExportModal(false)} maxWidth="sm" fullWidth sx={{ '& .MuiDialog-paper': { display: 'flex', flexDirection: 'column', borderRadius: '10px' } }}>
        <DialogTitle sx={{ fontWeight: 600, color: '#111827', margin: 1, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          EXPORT
          <Button
            onClick={() => setOpenExportModal(false)}
            sx={{
              minWidth: 'auto',
              padding: '4px',
              color: '#6b7280',
              '&:hover': {
                backgroundColor: 'rgba(0, 0, 0, 0.04)'
              }
            }}
          >
            <CloseIcon sx={{ fontSize: '20px' }} />
          </Button>
        </DialogTitle>
        <Divider sx={{ margin: 0 }} />
        <DialogContent sx={{ display: 'flex', flexDirection: 'column', gap: 0, padding: 0 }}>
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5, padding: '36px' }}>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
              <Select
                size="small"
                defaultValue="json"
                sx={{ fontSize: '14px' }}
                displayEmpty
              >
                <MenuItem value="json">JSON</MenuItem>
                <MenuItem value="csv">CSV</MenuItem>
                <MenuItem value="pdf">PDF</MenuItem>
              </Select>
            </Box>

          </Box>

          <Divider sx={{ margin: 0 }} />

          <Box sx={{ display: 'flex', gap: 1, padding: '36px' }}>
            <Button
              size="small"
              variant="outlined"
              sx={{
                flex: 1,
                textTransform: 'none',
                borderColor: '#d1d5db',
                color: '#374151',
                fontSize: '14px',
                fontWeight: 500
              }}
              onClick={() => setOpenExportModal(false)}
            >
              Cancel
            </Button>
            <Button
              size="small"
              variant="contained"
              sx={{
                flex: 1,
                textTransform: 'none',
                backgroundColor: '#047857',
                color: '#ffffff',
                fontSize: '14px',
                fontWeight: 500,
                '&:hover': {
                  backgroundColor: '#065f46'
                }
              }}
              onClick={() => setOpenExportModal(false)}
            >
              Export
            </Button>
          </Box>
        </DialogContent>
      </Dialog>
    };

    const PublishModal = () => {
      return <Dialog open={openPublishModal} onClose={() => setOpenPublishModal(false)} maxWidth="sm" fullWidth sx={{ '& .MuiDialog-paper': { display: 'flex', flexDirection: 'column', borderRadius: '10px' } }}>
        <DialogTitle sx={{ fontWeight: 600, color: '#111827', margin: 1, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          PUBLISH
          <Button
            onClick={() => setOpenPublishModal(false)}
            sx={{
              minWidth: 'auto',
              padding: '4px',
              color: '#6b7280',
              '&:hover': {
                backgroundColor: 'rgba(0, 0, 0, 0.04)'
              }
            }}
          >
            <CloseIcon sx={{ fontSize: '20px' }} />
          </Button>
        </DialogTitle>
        <Divider sx={{ margin: 0 }} />
        <DialogContent sx={{ display: 'flex', flexDirection: 'column', gap: 0, padding: 0 }}>
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5, padding: '36px' }}>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1, marginBottom: 2 }}>
              <Select
                size="small"
                defaultValue="public"
                sx={{ fontSize: '14px' }}
                displayEmpty
              >
                <MenuItem value="public">Public</MenuItem>
                <MenuItem value="private">Private</MenuItem>
                <MenuItem value="draft">Draft</MenuItem>
              </Select>
            </Box>

            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
              <Typography sx={{ fontSize: '14px', color: '#6b7280', fontWeight: 500 }}>URL</Typography>
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                <Link
                  href="https://form.example.com/your-form"
                  target="_blank"
                  rel="noopener noreferrer"
                  sx={{
                    fontSize: '14px',
                    color: '#047857',
                    textDecoration: 'none',
                    cursor: 'pointer',
                    flex: 1,
                    '&:hover': {
                      textDecoration: 'underline'
                    }
                  }}
                >
                  https://form.example.com/your-form
                </Link>
                <Button
                  size="small"
                  onClick={() => {
                    navigator.clipboard.writeText('https://form.example.com/your-form');
                  }}
                  sx={{
                    minWidth: 'auto',
                    padding: '4px',
                    color: '#047857',
                    '&:hover': {
                      backgroundColor: 'rgba(4, 120, 87, 0.08)'
                    }
                  }}
                >
                  <ContentCopyIcon sx={{ fontSize: '16px' }} />
                </Button>
              </Box>
            </Box>
          </Box>

          <Divider sx={{ margin: 0 }} />

          <Box sx={{ display: 'flex', gap: 1, padding: '36px' }}>
            <Button
              size="small"
              variant="outlined"
              sx={{
                flex: 1,
                textTransform: 'none',
                borderColor: '#d1d5db',
                color: '#374151',
                fontSize: '14px',
                fontWeight: 500
              }}
              onClick={() => setOpenPublishModal(false)}
            >
              Cancel
            </Button>
            <Button
              size="small"
              variant="contained"
              sx={{
                flex: 1,
                textTransform: 'none',
                backgroundColor: '#047857',
                color: '#ffffff',
                fontSize: '14px',
                fontWeight: 500,
                '&:hover': {
                  backgroundColor: '#065f46'
                }
              }}
              onClick={() => setOpenPublishModal(false)}
            >
              Publish
            </Button>
          </Box>
        </DialogContent>
      </Dialog>
    };

    const ConditionalLogicModal = () => {
      return <Dialog open={openConditionalLogicModal} onClose={() => setOpenConditionalLogicModal(false)} maxWidth="sm" fullWidth sx={{ '& .MuiDialog-paper': { minHeight: '500px', display: 'flex', flexDirection: 'column', borderRadius: '10px' } }}>
        <DialogTitle sx={{ fontWeight: 600, color: '#111827' }}>Add Conditional Logic</DialogTitle>
        <DialogContent sx={{ flex: 1, py: 3 }}>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setOpenConditionalLogicModal(false)} sx={{ color: '#374151' }}>
            Cancel
          </Button>
          <Button
            onClick={() => setOpenConditionalLogicModal(false)}
            variant="contained"
            sx={{
              backgroundColor: '#047857',
              '&:hover': { backgroundColor: '#036644' }
            }}
          >
            Save
          </Button>
        </DialogActions>
      </Dialog>
    };

    const IAChat = () => {
      return <Dialog open={openChatToCreateModal} onClose={() => setOpenChatToCreateModal(false)} maxWidth="sm" fullWidth sx={{ '& .MuiDialog-paper': { display: 'flex', flexDirection: 'column', borderRadius: '10px', height: '600px' } }}>
        <DialogTitle sx={{ fontWeight: 600, color: '#111827', margin: 1, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          CHAT TO CREATE
          <Button
            onClick={() => setOpenChatToCreateModal(false)}
            sx={{
              minWidth: 'auto',
              padding: '4px',
              color: '#6b7280',
              '&:hover': {
                backgroundColor: 'rgba(0, 0, 0, 0.04)'
              }
            }}
          >
            <CloseIcon sx={{ fontSize: '20px' }} />
          </Button>
        </DialogTitle>
        <Divider sx={{ margin: 0 }} />
        <DialogContent sx={{ display: 'flex', flexDirection: 'column', gap: 0, padding: 0, flex: 1 }}>
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5, padding: '36px', flex: 1, overflowY: 'auto' }}>
            <style>{`
              .chat-bubble-left { gap: 0 !important; }
              .chat-bubble-right { gap: 0 !important; }
            `}</style>
            {/* Bot message 1 */}
            <Box sx={{ display: 'flex', justifyContent: 'flex-start', alignItems: 'flex-end', gap: 0 }}>
              <Box sx={{
                width: 0,
                height: 0,
                borderLeft: '8px solid transparent',
                borderRight: '0px solid transparent',
                borderBottom: '8px solid #f3f4f6',
                alignSelf: 'flex-end'
              }} />
              <Box sx={{ backgroundColor: '#f3f4f6', borderRadius: '8px', borderBottomLeftRadius: 0, padding: '12px 16px', maxWidth: '80%' }}>
                <Typography sx={{ fontSize: '14px', color: '#111827', lineHeight: 1.5 }}>
                  I'm here to help you improve your form. Could you tell me a bit more about what you'd like to do? For example, do you want to add new questions?
                </Typography>
              </Box>
            </Box>

            {/* User message 1 */}
            <Box sx={{ display: 'flex', justifyContent: 'flex-end', alignItems: 'flex-end', gap: 0 }}>
              <Box sx={{ backgroundColor: '#047857', borderRadius: '8px', borderBottomRightRadius: 0, padding: '12px 16px', maxWidth: '80%' }}>
                <Typography sx={{ fontSize: '14px', color: '#ffffff', lineHeight: 1.5 }}>
                  I want to create a question of how many students are in the class?
                </Typography>
              </Box>
              <Box sx={{
                width: 0,
                height: 0,
                borderLeft: '0px solid transparent',
                borderRight: '8px solid transparent',
                borderBottom: '8px solid #047857',
                alignSelf: 'flex-end'
              }} />
            </Box>

            {/* Bot message 2 */}
            <Box sx={{ display: 'flex', justifyContent: 'flex-start', alignItems: 'flex-end', gap: 0 }}>
              <Box sx={{
                width: 0,
                height: 0,
                borderLeft: '8px solid transparent',
                borderRight: '0px solid transparent',
                borderBottom: '8px solid #f3f4f6',
                alignSelf: 'flex-end'
              }} />
              <Box sx={{ backgroundColor: '#f3f4f6', borderRadius: '8px', borderBottomLeftRadius: 0, padding: '12px 16px', maxWidth: '80%' }}>
                <Typography sx={{ fontSize: '14px', color: '#111827', lineHeight: 1.5 }}>
                  Would you like the question to ask for an exact number, a range, or provide multiple choice options? And what should the second question be about?
                </Typography>
              </Box>
            </Box>

            {/* User message 2 */}
            <Box sx={{ display: 'flex', justifyContent: 'flex-end', alignItems: 'flex-end', gap: 0 }}>
              <Box sx={{ backgroundColor: '#047857', borderRadius: '8px', borderBottomRightRadius: 0, padding: '12px 16px', maxWidth: '80%' }}>
                <Typography sx={{ fontSize: '14px', color: '#ffffff', lineHeight: 1.5 }}>
                  Exact number
                </Typography>
              </Box>
              <Box sx={{
                width: 0,
                height: 0,
                borderLeft: '0px solid transparent',
                borderRight: '8px solid transparent',
                borderBottom: '8px solid #047857',
                alignSelf: 'flex-end'
              }} />
            </Box>

            {/* Bot message 3 with Preview button */}
            <Box sx={{ display: 'flex', justifyContent: 'flex-start', alignItems: 'flex-end', gap: 0 }}>
              <Box sx={{
                width: 0,
                height: 0,
                borderLeft: '8px solid transparent',
                borderRight: '0px solid transparent',
                borderBottom: '8px solid #f3f4f6',
                alignSelf: 'flex-start'
              }} />
              <Box sx={{ backgroundColor: '#f3f4f6', borderRadius: '8px', borderBottomLeftRadius: 0, padding: '12px 16px', maxWidth: '80%' }}>
                <Typography sx={{ fontSize: '14px', color: '#111827', lineHeight: 1.5, marginBottom: 1 }}>
                  Got it. Added question for number of students.
                </Typography>
                <Button
                  size="small"
                  variant="outlined"
                  sx={{
                    textTransform: 'none',
                    borderColor: '#047857',
                    color: '#047857',
                    fontSize: '12px',
                    fontWeight: 500
                  }}
                >
                  Preview
                </Button>
              </Box>
            </Box>
          </Box>

          <Divider sx={{ margin: 0 }} />

          <Box sx={{ display: 'flex', gap: 1, padding: '36px', alignItems: 'flex-end' }}>
            <TextField
              fullWidth
              placeholder="Ask me anything..."
              multiline
              maxRows={3}
              variant="outlined"
              size="small"
              sx={{ fontSize: '14px' }}
            />
            <Button
              size="small"
              variant="contained"
              sx={{
                textTransform: 'none',
                backgroundColor: '#047857',
                color: '#ffffff',
                fontSize: '14px',
                fontWeight: 500,
                padding: '8px 16px',
                '&:hover': {
                  backgroundColor: '#065f46'
                }
              }}
            >
              Send
            </Button>
          </Box>
        </DialogContent>
      </Dialog>
    };

    const MainCard = () => {

      const BreadcrumbBar = () => {
        return <Box className="breadcrumb-bar" sx={{ flexShrink: 0 }}>
          {/* Breadcrumb Section with Import and Chat buttons on left, action buttons on right */}
          <Box sx={{ px: 3, py: 1.5, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>

            {/* Left side - Title */}
            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
              {isEditingBreadcrumb ? (
                <TextField
                  autoFocus
                  value={breadcrumbTitle}
                  onChange={(e) => setBreadcrumbTitle(e.target.value)}
                  onBlur={() => setIsEditingBreadcrumb(false)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      setIsEditingBreadcrumb(false);
                    }
                  }}
                  size="small"
                  sx={{
                    '& .MuiOutlinedInput-root': {
                      fontSize: '18px',
                      fontWeight: 600,
                      color: '#111827',
                      '& fieldset': {
                        borderColor: '#047857'
                      }
                    }
                  }}
                />
              ) : (
                <>
                  <Typography sx={{ fontSize: '18px', fontWeight: 600, color: '#111827' }}>
                    {breadcrumbTitle}
                  </Typography>
                  <Tooltip title="Edit title">
                    <Button
                      onClick={() => setIsEditingBreadcrumb(true)}
                      size="small"
                      sx={{
                        minWidth: '32px',
                        width: '32px',
                        height: '32px',
                        padding: 0,
                        backgroundColor: 'transparent',
                        color: '#6b7280',
                        borderRadius: '4px',
                        '&:hover': {
                          backgroundColor: '#f3f4f6',
                          color: '#047857'
                        }
                      }}
                    >
                      <EditIcon fontSize="small" />
                    </Button>
                  </Tooltip>
                </>
              )}
            </Box>

            {/* Right side - Action Buttons and Publish Button */}
            <Box sx={{ display: 'flex', gap: 1, alignItems: 'center' }}>

              {/* Import Tool Button */}
              <Tooltip title="Import">
                <Button
                  onClick={() => setOpenImportModal(true)}
                  size="small"
                  sx={{
                    minWidth: '40px',
                    width: '40px',
                    height: '40px',
                    padding: 0,
                    backgroundColor: '#a6a6a6ff',
                    color: '#ffffff',
                    borderRadius: '6px',
                    '&:hover': {
                      backgroundColor: '#717171ff'
                    }
                  }}
                >
                  <FileDownloadIcon sx={{ fontSize: '20px' }} />
                </Button>
              </Tooltip>

              {/* Chat to Create Button */}
              <Tooltip title="Create with AI">
                <Button
                  onClick={() => setOpenChatToCreateModal(true)}
                  size="small"
                  sx={{
                    minWidth: '40px',
                    width: '40px',
                    height: '40px',
                    padding: 0,
                    backgroundColor: '#a6a6a6ff',
                    color: '#ffffff',
                    borderRadius: '6px',
                    '&:hover': {
                      backgroundColor: '#717171ff'
                    }
                  }}
                >
                  <AutoFixHighIcon sx={{ fontSize: '20px' }} />
                </Button>
              </Tooltip>

              {/* Preview Button */}
              <Tooltip title="Preview">
                <Button
                  onClick={() => setOpenPreviewModal(true)}
                  variant="contained"
                  size="small"
                  sx={{
                    minWidth: '40px',
                    width: '40px',
                    height: '40px',
                    padding: 0,
                    backgroundColor: '#e5e7eb',
                    color: '#6b7280',
                    boxShadow: 'none',
                    borderRadius: '8px',
                    '&:hover': {
                      backgroundColor: '#d1d5db',
                      boxShadow: 'none'
                    }
                  }}
                >
                  <VisibilityIcon fontSize="small" />
                </Button>
              </Tooltip>

              {/* Version History Button */}
              <Tooltip title="Version history">
                <Button
                  onClick={() => setOpenVersionHistoryModal(true)}
                  variant="contained"
                  size="small"
                  sx={{
                    minWidth: '40px',
                    width: '40px',
                    height: '40px',
                    padding: 0,
                    backgroundColor: '#e5e7eb',
                    color: '#6b7280',
                    boxShadow: 'none',
                    borderRadius: '8px',
                    '&:hover': {
                      backgroundColor: '#d1d5db',
                      boxShadow: 'none'
                    }
                  }}
                >
                  <HistoryIcon fontSize="small" />
                </Button>
              </Tooltip>

              {/* Export Button */}
              <Tooltip title="Export">
                <Button
                  onClick={() => setOpenExportModal(true)}
                  variant="contained"
                  size="small"
                  sx={{
                    minWidth: '40px',
                    width: '40px',
                    height: '40px',
                    padding: 0,
                    backgroundColor: '#e5e7eb',
                    color: '#6b7280',
                    boxShadow: 'none',
                    borderRadius: '8px',
                    '&:hover': {
                      backgroundColor: '#d1d5db',
                      boxShadow: 'none'
                    }
                  }}
                >
                  <FileUploadIcon fontSize="small" />
                </Button>
              </Tooltip>

              {/* Publish Button */}
              <Button
                onClick={() => setOpenPublishModal(true)}
                variant="contained"
                sx={{
                  backgroundColor: '#047857',
                  color: '#ffffff',
                  textTransform: 'none',
                  fontWeight: 600,
                  fontSize: '14px',
                  padding: '10px 20px',
                  height: '44px',
                  boxShadow: 'none',
                  borderRadius: '8px',
                  '&:hover': {
                    backgroundColor: '#036644',
                    boxShadow: 'none'
                  }
                }}
              >
                PUBLISH
              </Button>
            </Box>
          </Box>
        </Box>
      };

      const TabsRow = () => {
        const sections = useSelector((state) => state.formEditor.sections);
        const selectedSection = useSelector((state) => state.formEditor.selectedSection);

        const [draggedTabId, setDraggedTabId] = useState(null);
        const [dragOverTabId, setDragOverTabId] = useState(null);
        const [editingTabId, setEditingTabId] = useState(null);
        const [editingTabName, setEditingTabName] = useState('');

        const handleTabChange = (event, newValue) => {
          dispatch(setSelectedTab(newValue));
        };

        const handleTabDragStart = (tabId) => {
          setDraggedTabId(tabId);
        };

        const handleTabDragEnter = (e, tabId) => {
          e.preventDefault();
          if (tabId !== draggedTabId) {
            setDragOverTabId(tabId);
          }
        };

        const handleTabDragOver = (e, tabId) => {
          e.preventDefault();
        };

        const handleTabDragLeave = (e) => {
          e.preventDefault();
          setDragOverTabId(null);
        };

        const handleTabDrop = (e, tabId) => {
          e.preventDefault();
          if (draggedTabId && draggedTabId !== tabId) {
            const draggedIndex = sections.findIndex(t => t.id === draggedTabId);
            const dropIndex = sections.findIndex(t => t.id === tabId);
            const updatedSections = Array.from(sections);
            const [removed] = updatedSections.splice(draggedIndex, 1);
            updatedSections.splice(dropIndex, 0, removed);
            dispatch(setSections(updatedSections));
          }
          setDraggedTabId(null);
          setDragOverTabId(null);
        };

        return <Box sx={{ borderBottom: '1px solid #e5e7eb', px: 3, display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexShrink: 0 }}>
          <Tabs
            value={selectedTab}
            onChange={handleTabChange}
            sx={{
              '& .MuiTab-root': { color: '#6b7280', textTransform: 'none', fontWeight: 500, '&.Mui-selected': { color: '#047857' } },
              '& .MuiTabs-indicator': { backgroundColor: '#047857', height: '3px', zIndex: 1 },
              flex: 1, '& > div': { display: 'flex', alignItems: 'center' }
            }}
          >
            {sections?.map((section, index) => (
              editingTabId === section.id ? (
                <Box key={section.id} onClick={(e) => e.stopPropagation()} sx={{ display: 'flex', alignItems: 'center' }} >
                  <input
                    autoFocus
                    type="text"
                    value={editingTabName}
                    onChange={(e) => setEditingTabName(e.target.value)}
                    onBlur={() => handleTabNameChange(editingTabName)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        handleTabNameChange(editingTabName);
                      } else if (e.key === 'Escape') {
                        setEditingTabId(null);
                        setEditingTabName('');
                      }
                    }}
                    style={{
                      width: '120px',
                      padding: '8px',
                      border: '2px solid #047857',
                      borderRadius: '4px',
                      fontSize: '14px',
                      fontWeight: 500,
                      color: '#6b7280',
                      fontFamily: 'Montserrat, Arial, sans-serif',
                      backgroundColor: '#ffffff'
                    }}
                  />
                </Box>
              ) : (
                <Tab
                  key={section.id}
                  value={section.id}
                  onClick={() => setSelectedForm(section.id)}
                  draggable
                  onDragStart={(e) => {
                    e.stopPropagation();
                    handleTabDragStart(section.id);
                  }}
                  onDragEnter={(e) => handleTabDragEnter(e, section.id)}
                  onDragOver={(e) => handleTabDragOver(e, section.id)}
                  onDragLeave={(e) => handleTabDragLeave(e)}
                  onDrop={(e) => handleTabDrop(e, section.id)}
                  label={
                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                      <span onDoubleClick={() => handleTabDoubleClick(section.id, section.title)} style={{ cursor: 'pointer' }}>{section.title}</span>
                      <CloseIcon
                        sx={{
                          fontSize: '16px',
                          color: '#6b7280',
                          cursor: 'pointer',
                          marginLeft: '4px',
                          '&:hover': {
                            color: '#dc2626'
                          }
                        }}
                        onClick={(e) => {
                          e.stopPropagation();
                          if (tabs.length > 1) {
                            const updatedTabs = tabs.filter(t => t.id !== tab.id);
                            setTabs(updatedTabs);
                            if (selectedTab === tab.id) {
                              setSelectedTab(updatedTabs[0]?.id || 1);
                            }
                          }
                        }}
                      />
                    </Box>
                  }
                  sx={{
                    position: 'relative',
                    opacity: draggedTabId === section.id ? 0.5 : 1,
                    backgroundColor: dragOverTabId === section.id ? '#dbeafe' : 'transparent',
                    borderLeft: dragOverTabId === section.id ? '4px solid #047857' : 'transparent',
                    transition: 'all 0.1s',
                    minWidth: 0,
                    cursor: 'grab',
                    '&:active': {
                      cursor: 'grabbing'
                    },
                    '&:hover': {
                      opacity: 0.8
                    }
                  }}
                />
              )
            ))}
            <Tab label={
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                <Button
                  onClick={() => {
                    const newId = Math.max(...tabs.map(t => t.id), 0) + 1;
                    setTabs([...tabs, { id: newId, label: `Section ${newId}` }]);
                    setSelectedForm(newId);
                  }}
                  sx={{
                    color: '#047857',
                    padding: '4px ',
                    fontSize: '14px',
                    fontWeight: 500,
                    backgroundColor: '#d6ece0ff',
                    borderRadius: '6px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    alignSelf: 'center',
                    textTransform: 'none',
                    gap: '6px',
                    flexShrink: 0,
                    '&:hover': {
                      backgroundColor: '#94d0b4ff',
                      color: '#047857'
                    }
                  }}
                >
                  <AddIcon sx={{ fontSize: '18px' }} />
                </Button>
              </Box>
            } />

          </Tabs>


        </Box>
      };

      const MainContent = () => {
        return <Box
          data-flex-container
          sx={{
            flex: 1,
            display: { xs: 'flex', md: 'flex' },
            width: '100%',
            flexDirection: { xs: 'column', md: 'row' },
            backgroundColor: '#ffffff',
            overflow: 'hidden'
          }}
        >
          {/* Middle Column - flexible width on desktop, full width on mobile */}
          <Box sx={{
            flex: { xs: '0 0 100%', md: `1 1 auto` },
            display: 'flex',
            flexDirection: 'column',
            borderBottom: { xs: '1px solid #e5e7eb', md: 'none' },
            minWidth: '0',
            minHeight: '0'
          }}>

            {/* Content Area - Two column layout */}
            <Box
              sx={{
                flex: 1,
                minHeight: 0,
                display: 'flex',
                flexDirection: 'row',
                gap: 0
              }}
            >
              {/* Left Sidebar - Question Type Buttons */}
              <Box
                sx={{
                  width: '80px',
                  borderRight: '1px solid #e5e7eb',
                  backgroundColor: '#ffffff',
                  flexShrink: 0,
                  p: 2,
                  display: 'flex',
                  flexDirection: 'column',
                  gap: 1,
                  alignItems: 'center',
                  overflowY: 'auto'
                }}
              >
                {/* Title */}
                <Typography sx={{ fontSize: '14px', fontWeight: 600, color: '#111827', textAlign: 'center' }}>
                  ADD
                </Typography>

                {/* Question Type Buttons */}
                <Tooltip title="Header">
                  <Button
                    draggable
                    onDragStart={() => handleComponentDragStart('Header')}
                    size="small"
                    sx={{
                      minWidth: '40px',
                      width: '40px',
                      height: '40px',
                      padding: 0,
                      backgroundColor: '#f3f4f6',
                      color: '#6b7280',
                      borderRadius: '6px',
                      cursor: 'grab',
                      boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)',
                      '&:hover': {
                        backgroundColor: '#e5e7eb'
                      },
                      '&:active': {
                        cursor: 'grabbing'
                      }
                    }}
                  >
                    <TitleIcon sx={{ fontSize: '20px' }} />
                  </Button>
                </Tooltip>
                <Tooltip title="Long Text">
                  <Button
                    draggable
                    onDragStart={() => handleComponentDragStart('Long Text')}
                    size="small"
                    sx={{
                      minWidth: '40px',
                      width: '40px',
                      height: '40px',
                      padding: 0,
                      backgroundColor: '#f3f4f6',
                      color: '#6b7280',
                      borderRadius: '6px',
                      cursor: 'grab',
                      boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)',
                      '&:hover': {
                        backgroundColor: '#e5e7eb'
                      },
                      '&:active': {
                        cursor: 'grabbing'
                      }
                    }}
                  >
                    <TextFieldsIcon sx={{ fontSize: '20px' }} />
                  </Button>
                </Tooltip>
                <Tooltip title="Short Text">
                  <Button
                    draggable
                    onDragStart={() => handleComponentDragStart('Short Text')}
                    size="small"
                    sx={{
                      minWidth: '40px',
                      width: '40px',
                      height: '40px',
                      padding: 0,
                      backgroundColor: '#f3f4f6',
                      color: '#6b7280',
                      borderRadius: '6px',
                      cursor: 'grab',
                      boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)',
                      '&:hover': {
                        backgroundColor: '#e5e7eb'
                      },
                      '&:active': {
                        cursor: 'grabbing'
                      }
                    }}
                  >
                    <TextFieldsIcon sx={{ fontSize: '20px' }} />
                  </Button>
                </Tooltip>
                <Tooltip title="Multiple Choice">
                  <Button
                    draggable
                    onDragStart={() => handleComponentDragStart('Multiple Choice')}
                    size="small"
                    sx={{
                      minWidth: '40px',
                      width: '40px',
                      height: '40px',
                      padding: 0,
                      backgroundColor: '#f3f4f6',
                      color: '#6b7280',
                      borderRadius: '6px',
                      cursor: 'grab',
                      boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)',
                      '&:hover': {
                        backgroundColor: '#e5e7eb'
                      },
                      '&:active': {
                        cursor: 'grabbing'
                      }
                    }}
                  >
                    <RadioButtonCheckedIcon sx={{ fontSize: '20px' }} />
                  </Button>
                </Tooltip>
                <Tooltip title="Yes/No">
                  <Button
                    draggable
                    onDragStart={() => handleComponentDragStart('Yes/No')}
                    size="small"
                    sx={{
                      minWidth: '40px',
                      width: '40px',
                      height: '40px',
                      padding: 0,
                      backgroundColor: '#f3f4f6',
                      color: '#6b7280',
                      borderRadius: '6px',
                      cursor: 'grab',
                      boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)',
                      '&:hover': {
                        backgroundColor: '#e5e7eb'
                      },
                      '&:active': {
                        cursor: 'grabbing'
                      }
                    }}
                  >
                    <ThumbsUpDownIcon sx={{ fontSize: '20px' }} />
                  </Button>
                </Tooltip>
                <Tooltip title="Checkbox">
                  <Button
                    draggable
                    onDragStart={() => handleComponentDragStart('Checkbox')}
                    size="small"
                    sx={{
                      minWidth: '40px',
                      width: '40px',
                      height: '40px',
                      padding: 0,
                      backgroundColor: '#f3f4f6',
                      color: '#6b7280',
                      borderRadius: '6px',
                      cursor: 'grab',
                      boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)',
                      '&:hover': {
                        backgroundColor: '#e5e7eb'
                      },
                      '&:active': {
                        cursor: 'grabbing'
                      }
                    }}
                  >
                    <CheckboxIcon sx={{ fontSize: '20px' }} />
                  </Button>
                </Tooltip>
                <Tooltip title="Number">
                  <Button
                    draggable
                    onDragStart={() => handleComponentDragStart('Number')}
                    size="small"
                    sx={{
                      minWidth: '40px',
                      width: '40px',
                      height: '40px',
                      padding: 0,
                      backgroundColor: '#f3f4f6',
                      color: '#6b7280',
                      borderRadius: '6px',
                      cursor: 'grab',
                      boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)',
                      '&:hover': {
                        backgroundColor: '#e5e7eb'
                      },
                      '&:active': {
                        cursor: 'grabbing'
                      }
                    }}
                  >
                    <NumbersIcon sx={{ fontSize: '20px' }} />
                  </Button>
                </Tooltip>
                <Tooltip title="Date">
                  <Button
                    draggable
                    onDragStart={() => handleComponentDragStart('Date')}
                    size="small"
                    sx={{
                      minWidth: '40px',
                      width: '40px',
                      height: '40px',
                      padding: 0,
                      backgroundColor: '#f3f4f6',
                      color: '#6b7280',
                      borderRadius: '6px',
                      cursor: 'grab',
                      boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)',
                      '&:hover': {
                        backgroundColor: '#e5e7eb'
                      },
                      '&:active': {
                        cursor: 'grabbing'
                      }
                    }}
                  >
                    <CalendarMonthIcon sx={{ fontSize: '20px' }} />
                  </Button>
                </Tooltip>
                <Tooltip title="Opinion Scale">
                  <Button
                    draggable
                    onDragStart={() => handleComponentDragStart('Opinion Scale')}
                    size="small"
                    sx={{
                      minWidth: '40px',
                      width: '40px',
                      height: '40px',
                      padding: 0,
                      backgroundColor: '#f3f4f6',
                      color: '#6b7280',
                      borderRadius: '6px',
                      cursor: 'grab',
                      boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)',
                      '&:hover': {
                        backgroundColor: '#e5e7eb'
                      },
                      '&:active': {
                        cursor: 'grabbing'
                      }
                    }}
                  >
                    <AssignmentIcon sx={{ fontSize: '20px' }} />
                  </Button>
                </Tooltip>
                <Tooltip title="Rating">
                  <Button
                    draggable
                    onDragStart={() => handleComponentDragStart('Rating')}
                    size="small"
                    sx={{
                      minWidth: '40px',
                      width: '40px',
                      height: '40px',
                      padding: 0,
                      backgroundColor: '#f3f4f6',
                      color: '#6b7280',
                      borderRadius: '6px',
                      cursor: 'grab',
                      boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)',
                      '&:hover': {
                        backgroundColor: '#e5e7eb'
                      },
                      '&:active': {
                        cursor: 'grabbing'
                      }
                    }}
                  >
                    <StarIcon sx={{ fontSize: '20px' }} />
                  </Button>
                </Tooltip>
              </Box>

              {/* Right Column - Questions and Cards */}
              <Box
                onDragOver={handleContentDragOver}
                onDragLeave={handleContentDragLeave}
                onDrop={handleContentDrop}
                sx={{
                  flex: 1,
                  p: 3,
                  overflowY: 'auto',
                  minHeight: 0,
                  display: 'flex',
                  flexDirection: 'column',
                  gap: 2,
                  backgroundColor: isDragOver ? '#d0eee4ff' : '#e8f6f2',
                  transition: 'background-color 0.2s'
                }}
              >
                {selectedTab === 1 && (
                  <>
                    {/* Card 1 - Header */}
                    <Box
                      onClick={() => { setSelectedCard(1); setSelectedSubquestion(null); }}
                      sx={{
                        backgroundColor: '#ffffff',
                        borderRadius: '10px',
                        border: selectedCard === 1 ? '3px solid #047857' : '1px solid #e5e7eb',
                        padding: 3,
                        minHeight: 'auto',
                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                        display: 'flex',
                        flexDirection: 'column',
                        position: 'relative',
                        transition: 'border-color 0.2s, box-shadow 0.2s, background-color 0.2s'
                      }}>
                      <Box sx={{ position: 'absolute', top: collapsedCards[1] ? '50%' : 12, right: 12, transform: collapsedCards[1] ? 'translateY(-50%)' : 'none', display: 'flex', gap: 1 }}>
                        <Tooltip title="Duplicate">
                          <Button
                            size="small"
                            sx={{
                              minWidth: '32px',
                              width: '32px',
                              height: '32px',
                              padding: 0,
                              backgroundColor: 'transparent',
                              color: '#6b7280',
                              borderRadius: '6px',
                              '&:hover': {
                                backgroundColor: '#f3f4f6'
                              }
                            }}
                          >
                            <ContentCopyIcon fontSize="small" />
                          </Button>
                        </Tooltip>
                        <Tooltip title="Delete">
                          <Button
                            size="small"
                            sx={{
                              minWidth: '32px',
                              width: '32px',
                              height: '32px',
                              padding: 0,
                              backgroundColor: 'transparent',
                              color: '#ef4444',
                              borderRadius: '6px',
                              '&:hover': {
                                backgroundColor: '#fee2e2'
                              }
                            }}
                          >
                            <DeleteOutlineIcon fontSize="small" />
                          </Button>
                        </Tooltip>
                      </Box>
                      <Box sx={{ position: 'absolute', left: 12, top: collapsedCards[1] ? '50%' : 12, transform: collapsedCards[1] ? 'translateY(-50%)' : 'none', display: 'flex', alignItems: 'center', gap: 0.5, cursor: 'grab', '&:active': { cursor: 'grabbing' } }}>
                        <DragIndicatorIcon sx={{ color: '#d1d5db', fontSize: '18px' }} />
                        <Tooltip title={collapsedCards[1] ? 'Expand' : 'Collapse'}>
                          <Button
                            size="small"
                            onClick={(e) => {
                              e.stopPropagation();
                              setCollapsedCards({ ...collapsedCards, 1: !collapsedCards[1] });
                            }}
                            sx={{
                              minWidth: '28px',
                              width: '28px',
                              height: '28px',
                              padding: 0,
                              backgroundColor: 'transparent',
                              color: '#6b7280',
                              borderRadius: '4px',
                              '&:hover': {
                                backgroundColor: '#f3f4f6'
                              }
                            }}
                          >
                            <ExpandMoreIcon sx={{ fontSize: '20px', color: '#047857', transform: collapsedCards[1] ? 'rotate(-90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
                          </Button>
                        </Tooltip>
                      </Box>
                      <Box sx={{ position: 'absolute', left: 100, top: collapsedCards[1] ? '50%' : 12, transform: collapsedCards[1] ? 'translateY(-50%)' : 'none', display: 'flex', alignItems: 'center', gap: 1 }}>
                        <Box sx={{ display: 'flex', alignItems: 'center' }}>
                          {getComponentIcon('Header') &&
                            React.cloneElement(getComponentIcon('Header'), {
                              sx: { fontSize: '18px', color: '#8c8c8c' }
                            })
                          }
                        </Box>
                        <Button
                          endIcon={<ExpandMoreIcon />}
                          sx={{
                            backgroundColor: 'transparent',
                            color: '#374151',
                            textTransform: 'none',
                            fontWeight: 500,
                            fontSize: '13px',
                            padding: '6px 12px',
                            borderRadius: '6px',
                            '&:hover': {
                              backgroundColor: '#f3f4f6'
                            }
                          }}
                        >
                          Header
                        </Button>
                      </Box>
                      {!collapsedCards[1] && (
                        <Box sx={{ borderTop: '1px solid #e5e7eb', marginTop: 4, marginBottom: 2, marginLeft: 3 }} />
                      )}
                      {!collapsedCards[1] && (
                        <Box sx={{ paddingLeft: '50px', paddingTop: 2, paddingRight: 6 }}>
                          {/* Title Section */}
                          <Box sx={{ marginBottom: 3 }}>
                            {showFormatButtons === 'card1title' && (
                              <Box sx={{ display: 'flex', gap: 0.5, marginBottom: 1 }}>
                                <Tooltip title="Bold">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleBold(!sectionTitleBold)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleBold ? '#047857' : '#f3f4f6',
                                      color: sectionTitleBold ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleBold ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatBoldIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Italic">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleItalic(!sectionTitleItalic)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleItalic ? '#047857' : '#f3f4f6',
                                      color: sectionTitleItalic ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleItalic ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatItalicIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Underline">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleUnderline(!sectionTitleUnderline)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleUnderline ? '#047857' : '#f3f4f6',
                                      color: sectionTitleUnderline ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleUnderline ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatUnderlinedIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Bulleted List">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleBulletList(!sectionTitleBulletList)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleBulletList ? '#047857' : '#f3f4f6',
                                      color: sectionTitleBulletList ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleBulletList ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatListBulletedIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Numbered List">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleNumberedList(!sectionTitleNumberedList)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleNumberedList ? '#047857' : '#f3f4f6',
                                      color: sectionTitleNumberedList ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleNumberedList ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatListNumberedIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Link">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleLink(!sectionTitleLink)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleLink ? '#047857' : '#f3f4f6',
                                      color: sectionTitleLink ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleLink ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <LinkIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                              </Box>
                            )}
                            <Box sx={{ display: 'flex', gap: 1, alignItems: 'center' }}>
                              <TextField
                                fullWidth
                                value={sectionTitle}
                                onChange={(e) => setSectionTitle(e.target.value)}
                                size="small"
                                sx={{
                                  '& .MuiOutlinedInput-root': {
                                    fontWeight: sectionTitleBold ? 600 : 400,
                                    fontStyle: sectionTitleItalic ? 'italic' : 'normal',
                                    textDecoration: sectionTitleUnderline ? 'underline' : 'none',
                                    color: '#111827',
                                    backgroundColor: '#f9fafb',
                                    '& fieldset': {
                                      borderColor: '#e5e7eb'
                                    },
                                    '&:hover fieldset': {
                                      borderColor: '#d1d5db'
                                    },
                                    '&.Mui-focused fieldset': {
                                      borderColor: '#047857'
                                    }
                                  }
                                }}
                              />
                              <Tooltip title="Text format">
                                <Button
                                  size="small"
                                  onClick={() => setShowFormatButtons(showFormatButtons === 'card1title' ? null : 'card1title')}
                                  sx={{
                                    minWidth: '40px',
                                    width: '40px',
                                    height: '40px',
                                    padding: 0,
                                    backgroundColor: showFormatButtons === 'card1title' ? '#047857' : '#f3f4f6',
                                    color: showFormatButtons === 'card1title' ? '#ffffff' : '#374151',
                                    borderRadius: '6px',
                                    flexShrink: 0,
                                    '&:hover': {
                                      backgroundColor: showFormatButtons === 'card1title' ? '#036644' : '#e5e7eb'
                                    }
                                  }}
                                >
                                  <FormatColorTextIcon sx={{ fontSize: '20px' }} />
                                </Button>
                              </Tooltip>
                            </Box>
                          </Box>

                          {/* Description Section */}
                          <Box sx={{ marginBottom: 2 }}>
                            {showFormatButtons === 'description' && (
                              <Box sx={{ display: 'flex', gap: 0.5, marginBottom: 1 }}>
                                <Tooltip title="Bold">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionDescBold(!sectionDescBold)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionDescBold ? '#047857' : '#f3f4f6',
                                      color: sectionDescBold ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionDescBold ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatBoldIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Italic">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionDescItalic(!sectionDescItalic)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionDescItalic ? '#047857' : '#f3f4f6',
                                      color: sectionDescItalic ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionDescItalic ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatItalicIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Underline">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionDescUnderline(!sectionDescUnderline)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionDescUnderline ? '#047857' : '#f3f4f6',
                                      color: sectionDescUnderline ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionDescUnderline ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatUnderlinedIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Bulleted List">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionDescBulletList(!sectionDescBulletList)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionDescBulletList ? '#047857' : '#f3f4f6',
                                      color: sectionDescBulletList ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionDescBulletList ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatListBulletedIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Numbered List">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionDescNumberedList(!sectionDescNumberedList)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionDescNumberedList ? '#047857' : '#f3f4f6',
                                      color: sectionDescNumberedList ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionDescNumberedList ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatListNumberedIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Link">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionDescLink(!sectionDescLink)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionDescLink ? '#047857' : '#f3f4f6',
                                      color: sectionDescLink ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionDescLink ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <LinkIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                              </Box>
                            )}
                            <Box sx={{ display: 'flex', gap: 1, alignItems: 'flex-start' }}>
                              <TextField
                                fullWidth
                                value={sectionDescription}
                                onChange={(e) => setSectionDescription(e.target.value)}
                                size="small"
                                multiline
                                rows={2.5}
                                sx={{
                                  '& .MuiOutlinedInput-root': {
                                    fontWeight: sectionDescBold ? 600 : 400,
                                    fontStyle: sectionDescItalic ? 'italic' : 'normal',
                                    textDecoration: sectionDescUnderline ? 'underline' : 'none',
                                    color: '#6b7280',
                                    backgroundColor: '#f9fafb',
                                    fontSize: '14px',
                                    '& fieldset': {
                                      borderColor: '#e5e7eb'
                                    },
                                    '&:hover fieldset': {
                                      borderColor: '#d1d5db'
                                    },
                                    '&.Mui-focused fieldset': {
                                      borderColor: '#047857'
                                    }
                                  }
                                }}
                              />
                              <Tooltip title="Text format">
                                <Button
                                  size="small"
                                  onClick={() => setShowFormatButtons(showFormatButtons === 'description' ? null : 'description')}
                                  sx={{
                                    minWidth: '40px',
                                    width: '40px',
                                    height: '40px',
                                    padding: 0,
                                    backgroundColor: showFormatButtons === 'description' ? '#047857' : '#f3f4f6',
                                    color: showFormatButtons === 'description' ? '#ffffff' : '#374151',
                                    borderRadius: '6px',
                                    flexShrink: 0,
                                    marginTop: '4px',
                                    '&:hover': {
                                      backgroundColor: showFormatButtons === 'description' ? '#036644' : '#e5e7eb'
                                    }
                                  }}
                                >
                                  <FormatColorTextIcon sx={{ fontSize: '20px' }} />
                                </Button>
                              </Tooltip>
                            </Box>
                          </Box>
                        </Box>
                      )}
                    </Box>


                    {/* Card 2 - Multiple Choice */}
                    <Box
                      onClick={() => { setSelectedCard(2); setSelectedSubquestion(null); }}
                      sx={{
                        backgroundColor: '#ffffff',
                        borderRadius: '10px',
                        border: selectedCard === 2 ? '3px solid #047857' : '1px solid #e5e7eb',
                        padding: 3,
                        minHeight: 'auto',
                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                        display: 'flex',
                        flexDirection: 'column',
                        position: 'relative',
                        overflow: 'visible',
                        transition: 'border-color 0.2s, box-shadow 0.2s, background-color 0.2s'
                      }}>
                      <Box sx={{ position: 'absolute', top: collapsedCards[2] ? '50%' : 12, right: 12, transform: collapsedCards[2] ? 'translateY(-50%)' : 'none', display: 'flex', gap: 1, alignItems: 'center' }}>
                        <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                          <Typography sx={{ fontSize: '12px', color: '#374151', fontWeight: 500 }}>
                            Required
                          </Typography>
                          <Tooltip title="Required">
                            <Switch
                              size="small"
                              checked={multipleChoiceSettings.required}
                              onChange={(e) => setMultipleChoiceSettings({
                                ...multipleChoiceSettings,
                                required: e.target.checked
                              })}
                              sx={{
                                margin: 0
                              }}
                            />
                          </Tooltip>
                        </Box>
                        <Tooltip title="Duplicate">
                          <Button
                            size="small"
                            sx={{
                              minWidth: '32px',
                              width: '32px',
                              height: '32px',
                              padding: 0,
                              backgroundColor: 'transparent',
                              color: '#6b7280',
                              borderRadius: '6px',
                              '&:hover': {
                                backgroundColor: '#f3f4f6'
                              }
                            }}
                          >
                            <ContentCopyIcon fontSize="small" />
                          </Button>
                        </Tooltip>
                        <Tooltip title="Delete">
                          <Button
                            size="small"
                            sx={{
                              minWidth: '32px',
                              width: '32px',
                              height: '32px',
                              padding: 0,
                              backgroundColor: 'transparent',
                              color: '#ef4444',
                              borderRadius: '6px',
                              '&:hover': {
                                backgroundColor: '#fee2e2'
                              }
                            }}
                          >
                            <DeleteOutlineIcon fontSize="small" />
                          </Button>
                        </Tooltip>
                      </Box>
                      <Box sx={{ position: 'absolute', left: 12, top: collapsedCards[2] ? '50%' : 12, transform: collapsedCards[2] ? 'translateY(-50%)' : 'none', display: 'flex', alignItems: 'center', gap: 0.5, cursor: 'grab', '&:active': { cursor: 'grabbing' } }}>
                        <DragIndicatorIcon sx={{ color: '#d1d5db', fontSize: '18px' }} />
                        <Tooltip title={collapsedCards[2] ? 'Expand' : 'Collapse'}>
                          <Button
                            size="small"
                            onClick={(e) => {
                              e.stopPropagation();
                              setCollapsedCards({ ...collapsedCards, 2: !collapsedCards[2] });
                            }}
                            sx={{
                              minWidth: '28px',
                              width: '28px',
                              height: '28px',
                              padding: 0,
                              backgroundColor: 'transparent',
                              color: '#6b7280',
                              borderRadius: '4px',
                              '&:hover': {
                                backgroundColor: '#f3f4f6'
                              }
                            }}
                          >
                            <ExpandMoreIcon sx={{ fontSize: '20px', color: '#047857', transform: collapsedCards[2] ? 'rotate(-90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
                          </Button>
                        </Tooltip>
                      </Box>
                      <Box sx={{ position: 'absolute', left: 100, top: collapsedCards[2] ? '50%' : 12, transform: collapsedCards[2] ? 'translateY(-50%)' : 'none', display: 'flex', alignItems: 'center', gap: 1 }}>
                        <Box sx={{ display: 'flex', alignItems: 'center' }}>
                          {getComponentIcon('Multiple Choice') &&
                            React.cloneElement(getComponentIcon('Multiple Choice'), {
                              sx: { fontSize: '18px', color: '#8c8c8c' }
                            })
                          }
                        </Box>
                        <Button
                          endIcon={<ExpandMoreIcon />}
                          onClick={(e) => setDropdownAnchor(e.currentTarget)}
                          sx={{
                            backgroundColor: 'transparent',
                            color: '#374151',
                            textTransform: 'none',
                            fontWeight: 500,
                            fontSize: '13px',
                            padding: '6px 12px',
                            borderRadius: '6px',
                            '&:hover': {
                              backgroundColor: '#f3f4f6'
                            }
                          }}
                        >
                          Multiple Choice
                        </Button>
                        <Menu
                          anchorEl={dropdownAnchor}
                          open={Boolean(dropdownAnchor)}
                          onClose={() => setDropdownAnchor(null)}
                        >
                          <MenuItem onClick={() => { setSelectedComponent('Long Text'); setDropdownAnchor(null); }}>Long Text</MenuItem>
                          <MenuItem onClick={() => { setSelectedComponent('Short Text'); setDropdownAnchor(null); }}>Short Text</MenuItem>
                          <MenuItem onClick={() => { setSelectedComponent('Multiple Choice'); setDropdownAnchor(null); }}>Multiple Choice</MenuItem>
                          <MenuItem onClick={() => { setSelectedComponent('Dropdown'); setDropdownAnchor(null); }}>Dropdown</MenuItem>
                          <MenuItem onClick={() => { setSelectedComponent('Yes/No'); setDropdownAnchor(null); }}>Yes/No</MenuItem>
                          <MenuItem onClick={() => { setSelectedComponent('Checkbox'); setDropdownAnchor(null); }}>Checkbox</MenuItem>
                          <MenuItem onClick={() => { setSelectedComponent('Number'); setDropdownAnchor(null); }}>Number</MenuItem>
                          <MenuItem onClick={() => { setSelectedComponent('Date'); setDropdownAnchor(null); }}>Date</MenuItem>
                          <MenuItem onClick={() => { setSelectedComponent('Opinion Scale'); setDropdownAnchor(null); }}>Opinion Scale</MenuItem>
                          <MenuItem onClick={() => { setSelectedComponent('Rating'); setDropdownAnchor(null); }}>Rating</MenuItem>
                          <MenuItem onClick={() => { setSelectedComponent('Ranking'); setDropdownAnchor(null); }}>Ranking</MenuItem>
                        </Menu>
                      </Box>
                      {!collapsedCards[2] && (
                        <Box sx={{ borderTop: '1px solid #e5e7eb', marginTop: 4, marginBottom: 2, marginLeft: 3 }} />
                      )}
                      {!collapsedCards[2] && (
                        <Box sx={{ paddingLeft: '50px', paddingTop: 2 }}>
                          {/* Title Section */}
                          <Box sx={{ marginBottom: 3 }}>
                            {showFormatButtons === 'card2title' && (
                              <Box sx={{ display: 'flex', gap: 0.5, marginBottom: 1 }}>
                                <Tooltip title="Bold">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleBold(!sectionTitleBold)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleBold ? '#047857' : '#f3f4f6',
                                      color: sectionTitleBold ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleBold ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatBoldIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Italic">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleItalic(!sectionTitleItalic)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleItalic ? '#047857' : '#f3f4f6',
                                      color: sectionTitleItalic ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleItalic ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatItalicIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Underline">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleUnderline(!sectionTitleUnderline)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleUnderline ? '#047857' : '#f3f4f6',
                                      color: sectionTitleUnderline ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleUnderline ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatUnderlinedIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Bulleted List">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleBulletList(!sectionTitleBulletList)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleBulletList ? '#047857' : '#f3f4f6',
                                      color: sectionTitleBulletList ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleBulletList ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatListBulletedIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Numbered List">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleNumberedList(!sectionTitleNumberedList)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleNumberedList ? '#047857' : '#f3f4f6',
                                      color: sectionTitleNumberedList ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleNumberedList ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatListNumberedIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Link">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleLink(!sectionTitleLink)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleLink ? '#047857' : '#f3f4f6',
                                      color: sectionTitleLink ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleLink ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <LinkIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                              </Box>
                            )}
                            <Box sx={{ display: 'flex', gap: 1, alignItems: 'center', paddingRight: 6 }}>
                              <TextField
                                fullWidth
                                value={sectionTitle}
                                onChange={(e) => setSectionTitle(e.target.value)}
                                size="small"
                                sx={{
                                  '& .MuiOutlinedInput-root': {
                                    fontWeight: sectionTitleBold ? 600 : 400,
                                    fontStyle: sectionTitleItalic ? 'italic' : 'normal',
                                    textDecoration: sectionTitleUnderline ? 'underline' : 'none',
                                    color: '#111827',
                                    backgroundColor: '#f9fafb',
                                    '& fieldset': {
                                      borderColor: '#e5e7eb'
                                    },
                                    '&:hover fieldset': {
                                      borderColor: '#d1d5db'
                                    },
                                    '&.Mui-focused fieldset': {
                                      borderColor: '#047857'
                                    }
                                  }
                                }}
                              />
                              <Tooltip title="Text format">
                                <Button
                                  size="small"
                                  onClick={() => setShowFormatButtons(showFormatButtons === 'card2title' ? null : 'card2title')}
                                  sx={{
                                    minWidth: '40px',
                                    width: '40px',
                                    height: '40px',
                                    padding: 0,
                                    backgroundColor: showFormatButtons === 'card2title' ? '#047857' : '#f3f4f6',
                                    color: showFormatButtons === 'card2title' ? '#ffffff' : '#374151',
                                    borderRadius: '6px',
                                    flexShrink: 0,
                                    '&:hover': {
                                      backgroundColor: showFormatButtons === 'card2title' ? '#036644' : '#e5e7eb'
                                    }
                                  }}
                                >
                                  <FormatColorTextIcon sx={{ fontSize: '20px' }} />
                                </Button>
                              </Tooltip>
                            </Box>
                          </Box>
                          {/* Multiple Choice Options */}
                          <Box sx={{ marginTop: 3, marginBottom: 3 }}>
                            <Box sx={{ display: 'flex', alignItems: 'center', marginBottom: 1.5, gap: 1, marginRight: '50px' }}>
                              <input type="radio" name="choice" disabled style={{ marginRight: '4px', cursor: 'not-allowed' }} />
                              <TextField
                                fullWidth
                                value={multipleChoiceOption1}
                                onChange={(e) => setMultipleChoiceOption1(e.target.value)}
                                size="small"
                                placeholder="Option 1"
                                variant="standard"
                                sx={{
                                  '& .MuiInput-root': {
                                    color: '#111827',
                                    fontSize: '14px',
                                    '&:before': {
                                      borderBottomColor: '#d1d5db'
                                    },
                                    '&:hover:before': {
                                      borderBottomColor: '#047857'
                                    },
                                    '&.Mui-focused:before': {
                                      borderBottomColor: '#047857'
                                    }
                                  }
                                }}
                              />
                            </Box>
                            <Box sx={{ display: 'flex', alignItems: 'center', marginBottom: 1.5, gap: 1, marginRight: '50px' }}>
                              <input type="radio" name="choice" disabled style={{ marginRight: '4px', cursor: 'not-allowed' }} />
                              <TextField
                                fullWidth
                                value={multipleChoiceOption2}
                                onChange={(e) => setMultipleChoiceOption2(e.target.value)}
                                size="small"
                                placeholder="Option 2"
                                variant="standard"
                                sx={{
                                  '& .MuiInput-root': {
                                    color: '#111827',
                                    fontSize: '14px',
                                    '&:before': {
                                      borderBottomColor: '#d1d5db'
                                    },
                                    '&:hover:before': {
                                      borderBottomColor: '#047857'
                                    },
                                    '&.Mui-focused:before': {
                                      borderBottomColor: '#047857'
                                    }
                                  }
                                }}
                              />
                            </Box>
                            <Box sx={{ display: 'flex', alignItems: 'center', marginBottom: 1.5, gap: 1, marginRight: '50px' }}>
                              <input type="radio" name="choice" disabled style={{ marginRight: '4px', cursor: 'not-allowed' }} />
                              <TextField
                                fullWidth
                                value={multipleChoiceOption3}
                                onChange={(e) => setMultipleChoiceOption3(e.target.value)}
                                size="small"
                                placeholder="Add option..."
                                variant="standard"
                                sx={{
                                  '& .MuiInput-root': {
                                    color: '#111827',
                                    fontSize: '14px',
                                    '&:before': {
                                      borderBottomColor: '#d1d5db'
                                    },
                                    '&:hover:before': {
                                      borderBottomColor: '#047857'
                                    },
                                    '&.Mui-focused:before': {
                                      borderBottomColor: '#047857'
                                    }
                                  }
                                }}
                              />
                            </Box>
                          </Box>
                        </Box>
                      )}

                      {/* Subquestions Container */}
                      {!collapsedCards[2] && subcomponents.length > 0 && (
                        <Box sx={{ paddingTop: 2 }}>
                          <Box sx={{ borderTop: '1px solid #e5e7eb', marginLeft: 4, marginBottom: 2 }} />
                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, paddingLeft: 4, marginBottom: 2 }}>
                            <Checkbox
                              size="small"
                              checked={subcomponents.length > 0 && subcomponents.every(sc => selectedSubcomponents[sc.id])}
                              indeterminate={subcomponents.some(sc => selectedSubcomponents[sc.id]) && !subcomponents.every(sc => selectedSubcomponents[sc.id])}
                              onChange={(e) => {
                                const newSelection = {};
                                subcomponents.forEach(sc => {
                                  newSelection[sc.id] = e.target.checked;
                                });
                                setSelectedSubcomponents(newSelection);
                              }}
                              sx={{ padding: 0 }}
                            />
                            <Typography sx={{ fontSize: '14px', color: '#047857', fontWeight: 500 }}>
                              Subquestions ({subcomponents.length})
                            </Typography>
                          </Box>
                          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, paddingLeft: 4 }}>
                            {subcomponents.map((subcomponent, index) => (
                              <Box
                                key={subcomponent.id}
                                onClick={(e) => { e.stopPropagation(); setSelectedCard(2); setSelectedSubquestion(subcomponent.id); }}
                                sx={{
                                  backgroundColor: '#ffffff',
                                  borderRadius: '8px',
                                  border: (selectedSubquestion === subcomponent.id || selectedSubcomponents[subcomponent.id]) ? '3px solid #047857' : '1px solid #e5e7eb',
                                  padding: 2,
                                  display: 'flex',
                                  flexDirection: 'column',
                                  gap: 2,
                                  position: 'relative',
                                  cursor: 'pointer',
                                  transition: 'all 0.2s',
                                  justifyContent: subcomponent.type === 'Subquestion' ? 'center' : 'flex-start',
                                  alignItems: subcomponent.type === 'Subquestion' ? 'center' : 'stretch',
                                  minHeight: collapsedSubcomponents[subcomponent.id] ? '50px' : (subcomponent.type === 'Subquestion' ? '100px' : 'auto')
                                }}
                              >
                                <Box sx={{ position: 'absolute', top: collapsedSubcomponents[subcomponent.id] ? '50%' : 12, right: 12, transform: collapsedSubcomponents[subcomponent.id] ? 'translateY(-50%)' : 'none', display: 'flex', gap: 1, alignItems: 'center' }}>
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                    <Typography sx={{ fontSize: '12px', color: '#374151', fontWeight: 500 }}>
                                      Required
                                    </Typography>
                                    <Tooltip title="Required">
                                      <Switch
                                        size="small"
                                        checked={subcomponent?.required || false}
                                        onChange={(e) => {
                                          e.stopPropagation();
                                          handleUpdateSubquestionRequired(subcomponent.id, e.target.checked);
                                        }}
                                        sx={{
                                          margin: 0
                                        }}
                                      />
                                    </Tooltip>
                                  </Box>
                                  <Tooltip title="Duplicate">
                                    <Button
                                      size="small"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        const duplicatedSubquestion = {
                                          ...subcomponent,
                                          id: Date.now(),
                                          title: `${subcomponent.title} (copy)`
                                        };
                                        setSubquestions([...subcomponents, duplicatedSubquestion]);
                                      }}
                                      sx={{
                                        minWidth: '32px',
                                        width: '32px',
                                        height: '32px',
                                        padding: 0,
                                        backgroundColor: 'transparent',
                                        color: '#6b7280',
                                        borderRadius: '4px',
                                        '&:hover': {
                                          backgroundColor: '#f3f4f6'
                                        }
                                      }}
                                    >
                                      <ContentCopyIcon fontSize="small" />
                                    </Button>
                                  </Tooltip>
                                  <Tooltip title="Delete">
                                    <Button
                                      size="small"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setSubquestions(subcomponents.filter(s => s.id !== subcomponent.id));
                                      }}
                                      sx={{
                                        minWidth: '32px',
                                        width: '32px',
                                        height: '32px',
                                        padding: 0,
                                        backgroundColor: 'transparent',
                                        color: '#ef4444',
                                        borderRadius: '4px',
                                        '&:hover': {
                                          backgroundColor: '#fee2e2'
                                        }
                                      }}
                                    >
                                      <DeleteOutlineIcon fontSize="small" />
                                    </Button>
                                  </Tooltip>
                                </Box>
                                <Box sx={{ position: 'absolute', left: 12, top: collapsedSubcomponents[subcomponent.id] ? '50%' : 12, transform: collapsedSubcomponents[subcomponent.id] ? 'translateY(-50%)' : 'none', display: 'flex', alignItems: 'center', gap: 0.5, cursor: 'grab', '&:active': { cursor: 'grabbing' } }}>
                                  <DragIndicatorIcon sx={{ color: '#d1d5db', fontSize: '18px' }} />
                                  <Checkbox
                                    size="small"
                                    checked={selectedSubcomponents[subcomponent.id] || false}
                                    onChange={(e) => {
                                      e.stopPropagation();
                                      setSelectedSubcomponents({ ...selectedSubcomponents, [subcomponent.id]: e.target.checked });
                                    }}
                                    sx={{ padding: 0 }}
                                  />
                                  <Tooltip title={collapsedSubcomponents[subcomponent.id] ? 'Expand' : 'Collapse'}>
                                    <Button
                                      size="small"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setCollapsedSubcomponents({ ...collapsedSubcomponents, [subcomponent.id]: !collapsedSubcomponents[subcomponent.id] });
                                      }}
                                      sx={{
                                        minWidth: '28px',
                                        width: '28px',
                                        height: '28px',
                                        padding: 0,
                                        backgroundColor: 'transparent',
                                        color: '#6b7280',
                                        borderRadius: '4px',
                                        '&:hover': {
                                          backgroundColor: '#f3f4f6'
                                        }
                                      }}
                                    >
                                      <ExpandMoreIcon sx={{ fontSize: '20px', color: '#047857', transform: collapsedSubcomponents[subcomponent.id] ? 'rotate(-90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
                                    </Button>
                                  </Tooltip>
                                </Box>
                                <Box sx={{ position: 'absolute', left: 100, top: collapsedSubcomponents[subcomponent.id] ? '50%' : 12, transform: collapsedSubcomponents[subcomponent.id] ? 'translateY(-50%)' : 'none', display: 'flex', alignItems: 'center', gap: 1 }}>
                                  <Button
                                    endIcon={<ExpandMoreIcon />}
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      setDropdownAnchor(e.currentTarget);
                                    }}
                                    sx={{
                                      backgroundColor: 'transparent',
                                      color: '#374151',
                                      textTransform: 'none',
                                      fontWeight: 500,
                                      fontSize: '13px',
                                      padding: '6px 12px',
                                      borderRadius: '6px',
                                      whiteSpace: 'nowrap',
                                      '&:hover': {
                                        backgroundColor: '#f3f4f6'
                                      }
                                    }}
                                  >
                                    {subcomponent.type}
                                  </Button>
                                  <Menu
                                    anchorEl={dropdownAnchor}
                                    open={Boolean(dropdownAnchor)}
                                    onClose={() => setDropdownAnchor(null)}
                                  >
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Header'); setDropdownAnchor(null); }}>Header</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Long Text'); setDropdownAnchor(null); }}>Long Text</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Short Text'); setDropdownAnchor(null); }}>Short Text</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Multiple Choice'); setDropdownAnchor(null); }}>Multiple Choice</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Dropdown'); setDropdownAnchor(null); }}>Dropdown</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Picture Choice'); setDropdownAnchor(null); }}>Picture Choice</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Yes/No'); setDropdownAnchor(null); }}>Yes/No</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Checkbox'); setDropdownAnchor(null); }}>Checkbox</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Number'); setDropdownAnchor(null); }}>Number</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Date'); setDropdownAnchor(null); }}>Date</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Opinion Scale'); setDropdownAnchor(null); }}>Opinion Scale</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Rating'); setDropdownAnchor(null); }}>Rating</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'Ranking'); setDropdownAnchor(null); }}>Ranking</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType(subcomponent.id, 'File Upload'); setDropdownAnchor(null); }}>File Upload</MenuItem>
                                  </Menu>
                                </Box>
                                {subcomponent.type !== 'Subquestion' && !collapsedSubcomponents[subcomponent.id] && (
                                  <>
                                    <Box sx={{ paddingLeft: '50px', paddingTop: 8, paddingRight: '20px', paddingBottom: 2 }}>
                                      {subcomponent.type === 'Short Text' && (
                                        <Box sx={{ display: 'flex', gap: 1, alignItems: 'center' }}>
                                          <TextField
                                            fullWidth
                                            placeholder="Placeholder text"
                                            size="small"
                                            value={subcomponent.text || ''}
                                            onClick={(e) => e.stopPropagation()}
                                            onChange={(e) => {
                                              e.stopPropagation();
                                              handleUpdateSubquestionText(subcomponent.id, e.target.value, true);
                                            }}
                                            sx={{
                                              '& .MuiOutlinedInput-root': {
                                                color: '#111827',
                                                backgroundColor: '#f9fafb',
                                                '& fieldset': {
                                                  borderColor: '#e5e7eb'
                                                },
                                                '&:hover fieldset': {
                                                  borderColor: '#d1d5db'
                                                },
                                                '&.Mui-focused fieldset': {
                                                  borderColor: '#047857'
                                                }
                                              }
                                            }}
                                          />
                                          <Tooltip title="Text format">
                                            <Button
                                              size="small"
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                setShowFormatButtons(showFormatButtons === `subcomp_${subcomponent.id}` ? null : `subcomp_${subcomponent.id}`);
                                              }}
                                              sx={{
                                                minWidth: '40px',
                                                width: '40px',
                                                height: '40px',
                                                padding: 0,
                                                backgroundColor: showFormatButtons === `subcomp_${subcomponent.id}` ? '#047857' : '#f3f4f6',
                                                color: showFormatButtons === `subcomp_${subcomponent.id}` ? '#ffffff' : '#374151',
                                                borderRadius: '6px',
                                                flexShrink: 0,
                                                '&:hover': {
                                                  backgroundColor: showFormatButtons === `subcomp_${subcomponent.id}` ? '#036644' : '#e5e7eb'
                                                }
                                              }}
                                            >
                                              <FormatColorTextIcon sx={{ fontSize: '20px' }} />
                                            </Button>
                                          </Tooltip>
                                        </Box>
                                      )}
                                    </Box>
                                  </>
                                )}
                              </Box>
                            ))}
                          </Box>
                        </Box>
                      )}
                    </Box>

                    {/* Card 3 - Opinion Scale */}
                    <Box
                      onClick={() => { setSelectedCard(3); setSelectedSubquestion(null); }}
                      sx={{
                        backgroundColor: '#ffffff',
                        borderRadius: '10px',
                        border: selectedCard === 3 ? '3px solid #047857' : '1px solid #e5e7eb',
                        padding: 3,
                        minHeight: 'auto',
                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                        display: 'flex',
                        flexDirection: 'column',
                        position: 'relative',
                        overflow: 'visible',
                        transition: 'border-color 0.2s, box-shadow 0.2s'
                      }}>
                      <Box sx={{ position: 'absolute', top: collapsedCards[3] ? '50%' : 12, right: 12, transform: collapsedCards[3] ? 'translateY(-50%)' : 'none', display: 'flex', gap: 1, alignItems: 'center' }}>
                        <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                          <Typography sx={{ fontSize: '12px', color: '#374151', fontWeight: 500 }}>
                            Required
                          </Typography>
                          <Tooltip title="Required">
                            <Switch
                              size="small"
                              sx={{
                                margin: 0
                              }}
                            />
                          </Tooltip>
                        </Box>
                        <Tooltip title="Duplicate">
                          <Button
                            size="small"
                            sx={{
                              minWidth: '32px',
                              width: '32px',
                              height: '32px',
                              padding: 0,
                              backgroundColor: 'transparent',
                              color: '#6b7280',
                              borderRadius: '6px',
                              '&:hover': {
                                backgroundColor: '#f3f4f6'
                              }
                            }}
                          >
                            <ContentCopyIcon fontSize="small" />
                          </Button>
                        </Tooltip>
                        <Tooltip title="Delete">
                          <Button
                            size="small"
                            sx={{
                              minWidth: '32px',
                              width: '32px',
                              height: '32px',
                              padding: 0,
                              backgroundColor: 'transparent',
                              color: '#ef4444',
                              borderRadius: '6px',
                              '&:hover': {
                                backgroundColor: '#fee2e2'
                              }
                            }}
                          >
                            <DeleteOutlineIcon fontSize="small" />
                          </Button>
                        </Tooltip>
                      </Box>
                      <Box sx={{ position: 'absolute', left: 12, top: collapsedCards[3] ? '50%' : 12, transform: collapsedCards[3] ? 'translateY(-50%)' : 'none', display: 'flex', alignItems: 'center', gap: 0.5, cursor: 'grab', '&:active': { cursor: 'grabbing' } }}>
                        <DragIndicatorIcon sx={{ color: '#d1d5db', fontSize: '18px' }} />
                        <Tooltip title={collapsedCards[3] ? 'Expand' : 'Collapse'}>
                          <Button
                            size="small"
                            onClick={(e) => {
                              e.stopPropagation();
                              setCollapsedCards({ ...collapsedCards, 3: !collapsedCards[3] });
                            }}
                            sx={{
                              minWidth: '28px',
                              width: '28px',
                              height: '28px',
                              padding: 0,
                              backgroundColor: 'transparent',
                              color: '#6b7280',
                              borderRadius: '4px',
                              '&:hover': {
                                backgroundColor: '#f3f4f6'
                              }
                            }}
                          >
                            <ExpandMoreIcon sx={{ fontSize: '20px', color: '#047857', transform: collapsedCards[3] ? 'rotate(-90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
                          </Button>
                        </Tooltip>
                      </Box>
                      <Box sx={{ position: 'absolute', left: 100, top: collapsedCards[3] ? '50%' : 12, transform: collapsedCards[3] ? 'translateY(-50%)' : 'none', display: 'flex', alignItems: 'center', gap: 1 }}>
                        <Box sx={{ display: 'flex', alignItems: 'center' }}>
                          {getComponentIcon('Opinion Scale') &&
                            React.cloneElement(getComponentIcon('Opinion Scale'), {
                              sx: { fontSize: '18px', color: '#8c8c8c' }
                            })
                          }
                        </Box>
                        <Button
                          endIcon={<ExpandMoreIcon />}
                          sx={{
                            backgroundColor: 'transparent',
                            color: '#374151',
                            textTransform: 'none',
                            fontWeight: 500,
                            fontSize: '13px',
                            padding: '6px 12px',
                            borderRadius: '6px',
                            '&:hover': {
                              backgroundColor: '#f3f4f6'
                            }
                          }}
                        >
                          Opinion Scale
                        </Button>
                      </Box>
                      {!collapsedCards[3] && (
                        <Box sx={{ borderTop: '1px solid #e5e7eb', marginTop: 4, marginBottom: 2, marginLeft: 3 }} />
                      )}
                      {!collapsedCards[3] && (
                        <Box sx={{ paddingLeft: '50px', paddingTop: 2 }}>
                          {/* Title Section */}
                          <Box sx={{ marginBottom: 2 }}>
                            {showFormatButtons === 'title' && (
                              <Box sx={{ display: 'flex', gap: 0.5, marginBottom: 1 }}>
                                <Tooltip title="Bold">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleBold(!sectionTitleBold)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleBold ? '#047857' : '#f3f4f6',
                                      color: sectionTitleBold ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleBold ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatBoldIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Italic">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleItalic(!sectionTitleItalic)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleItalic ? '#047857' : '#f3f4f6',
                                      color: sectionTitleItalic ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleItalic ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatItalicIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Underline">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleUnderline(!sectionTitleUnderline)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleUnderline ? '#047857' : '#f3f4f6',
                                      color: sectionTitleUnderline ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleUnderline ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatUnderlinedIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Bulleted List">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleBulletList(!sectionTitleBulletList)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleBulletList ? '#047857' : '#f3f4f6',
                                      color: sectionTitleBulletList ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleBulletList ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatListBulletedIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Numbered List">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleNumberedList(!sectionTitleNumberedList)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleNumberedList ? '#047857' : '#f3f4f6',
                                      color: sectionTitleNumberedList ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleNumberedList ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <FormatListNumberedIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                                <Tooltip title="Link">
                                  <Button
                                    size="small"
                                    onClick={() => setSectionTitleLink(!sectionTitleLink)}
                                    sx={{
                                      minWidth: '32px',
                                      width: '32px',
                                      height: '32px',
                                      padding: 0,
                                      backgroundColor: sectionTitleLink ? '#047857' : '#f3f4f6',
                                      color: sectionTitleLink ? '#ffffff' : '#374151',
                                      borderRadius: '4px',
                                      '&:hover': {
                                        backgroundColor: sectionTitleLink ? '#036644' : '#e5e7eb'
                                      }
                                    }}
                                  >
                                    <LinkIcon sx={{ fontSize: '16px' }} />
                                  </Button>
                                </Tooltip>
                              </Box>
                            )}
                            <Box sx={{ display: 'flex', gap: 1, alignItems: 'center', paddingRight: 6 }}>
                              <TextField
                                fullWidth
                                value={sectionTitle}
                                onChange={(e) => setSectionTitle(e.target.value)}
                                size="small"
                                sx={{
                                  '& .MuiOutlinedInput-root': {
                                    fontWeight: sectionTitleBold ? 600 : 400,
                                    fontStyle: sectionTitleItalic ? 'italic' : 'normal',
                                    textDecoration: sectionTitleUnderline ? 'underline' : 'none',
                                    color: '#111827',
                                    backgroundColor: '#f9fafb',
                                    '& fieldset': {
                                      borderColor: '#e5e7eb'
                                    },
                                    '&:hover fieldset': {
                                      borderColor: '#d1d5db'
                                    },
                                    '&.Mui-focused fieldset': {
                                      borderColor: '#047857'
                                    }
                                  }
                                }}
                              />
                              <Tooltip title="Text format">
                                <Button
                                  size="small"
                                  onClick={() => setShowFormatButtons(showFormatButtons === 'title' ? null : 'title')}
                                  sx={{
                                    minWidth: '40px',
                                    width: '40px',
                                    height: '40px',
                                    padding: 0,
                                    backgroundColor: showFormatButtons === 'title' ? '#047857' : '#f3f4f6',
                                    color: showFormatButtons === 'title' ? '#ffffff' : '#374151',
                                    borderRadius: '6px',
                                    flexShrink: 0,
                                    '&:hover': {
                                      backgroundColor: showFormatButtons === 'title' ? '#036644' : '#e5e7eb'
                                    }
                                  }}
                                >
                                  <FormatColorTextIcon sx={{ fontSize: '20px' }} />
                                </Button>
                              </Tooltip>
                            </Box>
                          </Box>
                          {/* Number Buttons 1-10 */}
                          <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1, marginTop: 3, marginBottom: 1 }}>
                            {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map((num) => (
                              <Button
                                key={num}
                                variant="outlined"
                                sx={{
                                  minWidth: '40px',
                                  width: '40px',
                                  height: '40px',
                                  padding: 0,
                                  borderColor: '#d1d5db',
                                  backgroundColor: '#ffffff',
                                  color: '#374151',
                                  fontWeight: 600,
                                  fontSize: '14px',
                                  borderRadius: '6px',
                                  pointerEvents: 'none'
                                }}
                              >
                                {num}
                              </Button>
                            ))}
                          </Box>
                        </Box>
                      )}

                      {/* Subquestions Container */}
                      {!collapsedCards[3] && subcomponents3.length > 0 && (
                        <Box sx={{ paddingTop: 2 }}>
                          <Box sx={{ borderTop: '1px solid #e5e7eb', marginLeft: 4, marginBottom: 2 }} />
                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, paddingLeft: 4, marginBottom: 2 }}>
                            <Checkbox
                              size="small"
                              checked={subcomponents3.length > 0 && subcomponents3.every(sc => selectedSubcomponents[sc.id])}
                              indeterminate={subcomponents3.some(sc => selectedSubcomponents[sc.id]) && !subcomponents3.every(sc => selectedSubcomponents[sc.id])}
                              onChange={(e) => {
                                const newSelection = {};
                                subcomponents3.forEach(sc => {
                                  newSelection[sc.id] = e.target.checked;
                                });
                                setSelectedSubcomponents(newSelection);
                              }}
                              sx={{ padding: 0 }}
                            />
                            <Typography sx={{ fontSize: '14px', color: '#047857', fontWeight: 500 }}>
                              Subquestions ({subcomponents3.length})
                            </Typography>
                          </Box>
                          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, paddingLeft: 4 }}>
                            {subcomponents3.map((subcomponent, index) => (
                              <Box
                                key={subcomponent.id}
                                onClick={(e) => { e.stopPropagation(); setSelectedCard(3); setSelectedSubquestion(subcomponent.id); }}
                                sx={{
                                  backgroundColor: '#ffffff',
                                  borderRadius: '8px',
                                  border: (selectedSubquestion === subcomponent.id || selectedSubcomponents[subcomponent.id]) ? '3px solid #047857' : '1px solid #e5e7eb',
                                  padding: 2,
                                  display: 'flex',
                                  flexDirection: 'column',
                                  gap: 2,
                                  position: 'relative',
                                  cursor: 'pointer',
                                  transition: 'all 0.2s',
                                  justifyContent: subcomponent.type === 'Subquestion' ? 'center' : 'flex-start',
                                  alignItems: subcomponent.type === 'Subquestion' ? 'center' : 'stretch',
                                  minHeight: collapsedSubcomponents[subcomponent.id] ? '50px' : (subcomponent.type === 'Subquestion' ? '100px' : 'auto')
                                }}
                              >
                                <Box sx={{ position: 'absolute', top: collapsedSubcomponents[subcomponent.id] ? '50%' : 12, right: 12, transform: collapsedSubcomponents[subcomponent.id] ? 'translateY(-50%)' : 'none', display: 'flex', gap: 1, alignItems: 'center' }}>
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                    <Typography sx={{ fontSize: '12px', color: '#374151', fontWeight: 500 }}>
                                      Required
                                    </Typography>
                                    <Tooltip title="Required">
                                      <Switch
                                        size="small"
                                        checked={subcomponent?.required || false}
                                        onChange={(e) => {
                                          e.stopPropagation();
                                          handleUpdateSubquestionRequired3(subcomponent.id, e.target.checked);
                                        }}
                                        sx={{
                                          margin: 0
                                        }}
                                      />
                                    </Tooltip>
                                  </Box>
                                  <Tooltip title="Duplicate">
                                    <Button
                                      size="small"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        const duplicatedSubquestion = {
                                          ...subcomponent,
                                          id: Date.now(),
                                          title: `${subcomponent.title} (copy)`
                                        };
                                        setSubquestions3([...subcomponents3, duplicatedSubquestion]);
                                      }}
                                      sx={{
                                        minWidth: '32px',
                                        width: '32px',
                                        height: '32px',
                                        padding: 0,
                                        backgroundColor: 'transparent',
                                        color: '#6b7280',
                                        borderRadius: '4px',
                                        '&:hover': {
                                          backgroundColor: '#f3f4f6'
                                        }
                                      }}
                                    >
                                      <ContentCopyIcon fontSize="small" />
                                    </Button>
                                  </Tooltip>
                                  <Tooltip title="Delete">
                                    <Button
                                      size="small"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setSubquestions3(subcomponents3.filter(s => s.id !== subcomponent.id));
                                      }}
                                      sx={{
                                        minWidth: '32px',
                                        width: '32px',
                                        height: '32px',
                                        padding: 0,
                                        backgroundColor: 'transparent',
                                        color: '#ef4444',
                                        borderRadius: '4px',
                                        '&:hover': {
                                          backgroundColor: '#fee2e2'
                                        }
                                      }}
                                    >
                                      <DeleteOutlineIcon fontSize="small" />
                                    </Button>
                                  </Tooltip>
                                </Box>
                                <Box sx={{ position: 'absolute', left: 12, top: collapsedSubcomponents[subcomponent.id] ? '50%' : 12, transform: collapsedSubcomponents[subcomponent.id] ? 'translateY(-50%)' : 'none', display: 'flex', alignItems: 'center', gap: 0.5, cursor: 'grab', '&:active': { cursor: 'grabbing' } }}>
                                  <DragIndicatorIcon sx={{ color: '#d1d5db', fontSize: '18px' }} />
                                  <Checkbox
                                    size="small"
                                    checked={selectedSubcomponents[subcomponent.id] || false}
                                    onChange={(e) => {
                                      e.stopPropagation();
                                      setSelectedSubcomponents({ ...selectedSubcomponents, [subcomponent.id]: e.target.checked });
                                    }}
                                    sx={{ padding: 0 }}
                                  />
                                  <Tooltip title={collapsedSubcomponents[subcomponent.id] ? 'Expand' : 'Collapse'}>
                                    <Button
                                      size="small"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setCollapsedSubcomponents({ ...collapsedSubcomponents, [subcomponent.id]: !collapsedSubcomponents[subcomponent.id] });
                                      }}
                                      sx={{
                                        minWidth: '28px',
                                        width: '28px',
                                        height: '28px',
                                        padding: 0,
                                        backgroundColor: 'transparent',
                                        color: '#6b7280',
                                        borderRadius: '4px',
                                        '&:hover': {
                                          backgroundColor: '#f3f4f6'
                                        }
                                      }}
                                    >
                                      <ExpandMoreIcon sx={{ fontSize: '20px', color: '#047857', transform: collapsedSubcomponents[subcomponent.id] ? 'rotate(-90deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
                                    </Button>
                                  </Tooltip>
                                </Box>
                                <Box sx={{ position: 'absolute', left: 100, top: collapsedSubcomponents[subcomponent.id] ? '50%' : 12, transform: collapsedSubcomponents[subcomponent.id] ? 'translateY(-50%)' : 'none', display: 'flex', alignItems: 'center', gap: 1 }}>
                                  <Button
                                    endIcon={<ExpandMoreIcon />}
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      setDropdownAnchor(e.currentTarget);
                                    }}
                                    sx={{
                                      backgroundColor: 'transparent',
                                      color: '#374151',
                                      textTransform: 'none',
                                      fontWeight: 500,
                                      fontSize: '13px',
                                      padding: '6px 12px',
                                      borderRadius: '6px',
                                      whiteSpace: 'nowrap',
                                      '&:hover': {
                                        backgroundColor: '#f3f4f6'
                                      }
                                    }}
                                  >
                                    {subcomponent.type}
                                  </Button>
                                  <Menu
                                    anchorEl={dropdownAnchor}
                                    open={Boolean(dropdownAnchor)}
                                    onClose={() => setDropdownAnchor(null)}
                                  >
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Header'); setDropdownAnchor(null); }}>Header</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Long Text'); setDropdownAnchor(null); }}>Long Text</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Short Text'); setDropdownAnchor(null); }}>Short Text</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Multiple Choice'); setDropdownAnchor(null); }}>Multiple Choice</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Dropdown'); setDropdownAnchor(null); }}>Dropdown</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Picture Choice'); setDropdownAnchor(null); }}>Picture Choice</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Yes/No'); setDropdownAnchor(null); }}>Yes/No</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Checkbox'); setDropdownAnchor(null); }}>Checkbox</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Number'); setDropdownAnchor(null); }}>Number</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Date'); setDropdownAnchor(null); }}>Date</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Opinion Scale'); setDropdownAnchor(null); }}>Opinion Scale</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Rating'); setDropdownAnchor(null); }}>Rating</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'Ranking'); setDropdownAnchor(null); }}>Ranking</MenuItem>
                                    <MenuItem onClick={() => { handleUpdateSubquestionType3(subcomponent.id, 'File Upload'); setDropdownAnchor(null); }}>File Upload</MenuItem>
                                  </Menu>
                                </Box>
                                {!collapsedSubcomponents[subcomponent.id] && (
                                  <>
                                    <Box sx={{ paddingLeft: '50px', paddingTop: 8, paddingRight: '20px', paddingBottom: 2 }}>
                                      {subcomponent.type === 'Short Text' && (
                                        <Box sx={{ display: 'flex', gap: 1, alignItems: 'center' }}>
                                          <TextField
                                            fullWidth
                                            placeholder="Placeholder text"
                                            size="small"
                                            value={subcomponent.text || ''}
                                            onClick={(e) => e.stopPropagation()}
                                            onChange={(e) => {
                                              e.stopPropagation();
                                              handleUpdateSubquestionText(subcomponent.id, e.target.value, false);
                                            }}
                                            sx={{
                                              '& .MuiOutlinedInput-root': {
                                                color: '#111827',
                                                backgroundColor: '#f9fafb',
                                                '& fieldset': {
                                                  borderColor: '#e5e7eb'
                                                },
                                                '&:hover fieldset': {
                                                  borderColor: '#d1d5db'
                                                },
                                                '&.Mui-focused fieldset': {
                                                  borderColor: '#047857'
                                                }
                                              }
                                            }}
                                          />
                                          <Tooltip title="Text format">
                                            <Button
                                              size="small"
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                setShowFormatButtons(showFormatButtons === `subcomp3_${subcomponent.id}` ? null : `subcomp3_${subcomponent.id}`);
                                              }}
                                              sx={{
                                                minWidth: '40px',
                                                width: '40px',
                                                height: '40px',
                                                padding: 0,
                                                backgroundColor: showFormatButtons === `subcomp3_${subcomponent.id}` ? '#047857' : '#f3f4f6',
                                                color: showFormatButtons === `subcomp3_${subcomponent.id}` ? '#ffffff' : '#374151',
                                                borderRadius: '6px',
                                                flexShrink: 0,
                                                '&:hover': {
                                                  backgroundColor: showFormatButtons === `subcomp3_${subcomponent.id}` ? '#036644' : '#e5e7eb'
                                                }
                                              }}
                                            >
                                              <FormatColorTextIcon sx={{ fontSize: '20px' }} />
                                            </Button>
                                          </Tooltip>
                                        </Box>
                                      )}
                                    </Box>
                                  </>
                                )}
                              </Box>
                            ))}
                          </Box>
                        </Box>
                      )}
                    </Box>
                  </>
                )}
                {/* Dotted rectangle to suggest adding more components */}
                <Box sx={{
                  backgroundColor: '#ffffff',
                  borderRadius: '10px',
                  border: '2px dotted #d1d5db',
                  padding: 2,
                  minHeight: 'auto',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: 3,
                  color: '#717171ff',
                  fontSize: '14px',
                  fontWeight: 500,
                  textAlign: 'center'
                }}>
                  <Box>Drag and drop questions to the section</Box>
                </Box>
              </Box>
            </Box>
          </Box>

          {/* Second Vertical Divider - draggable */}
          <Box
            onMouseDown={() => handleMouseDown('right')}
            sx={{
              width: { xs: '0px', md: '3px' },
              backgroundColor: '#e5e7eb',
              flexShrink: 0,
              display: { xs: 'none', md: 'block' },
              cursor: isDragging === 'right' ? 'col-resize' : 'col-resize',
              transition: isDragging ? 'none' : 'background-color 0.2s',
              '&:hover': {
                backgroundColor: '#d1d5db'
              },
              userSelect: 'none'
            }}
          />

          {/* Right Column - flexible width on desktop, full width on mobile */}
          <Box sx={{
            flex: { xs: '0 0 100%', md: `0 0 ${rightWidth}%` },
            p: 3,
            overflowY: 'auto',
            minWidth: '0',
            minHeight: '0',
            display: 'flex',
            flexDirection: 'column',
            gap: 2
          }}>

            {!selectedSubquestion && (
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                <SettingsIcon sx={{ fontSize: '20px', color: '#8c8c8c' }} />
                <Typography variant="subtitle2" sx={{ fontWeight: 600, color: '#111827' }}>
                  QUESTION SETTINGS
                </Typography>
              </Box>
            )}

            {selectedCard === 1 && !selectedSubquestion && (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5 }}>
                <Typography sx={{ fontSize: '12px', color: '#6b7280', fontStyle: 'italic' }}>
                  No additional settings for Header
                </Typography>
              </Box>
            )}

            {selectedCard === 2 && !selectedSubquestion && (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5 }}>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <Typography sx={{ fontSize: '12px', color: '#374151', fontWeight: 500 }}>
                    Multiple Selection
                  </Typography>
                  <Switch
                    size="small"
                    checked={multipleChoiceSettings.multipleSelection}
                    onChange={(e) => setMultipleChoiceSettings({
                      ...multipleChoiceSettings,
                      multipleSelection: e.target.checked
                    })}
                  />
                </Box>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <Typography sx={{ fontSize: '12px', color: '#374151', fontWeight: 500 }}>
                    Randomize
                  </Typography>
                  <Switch
                    size="small"
                    checked={multipleChoiceSettings.randomize}
                    onChange={(e) => setMultipleChoiceSettings({
                      ...multipleChoiceSettings,
                      randomize: e.target.checked
                    })}
                  />
                </Box>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <Typography sx={{ fontSize: '12px', color: '#374151', fontWeight: 500 }}>
                    "Other" option
                  </Typography>
                  <Switch
                    size="small"
                    checked={multipleChoiceSettings.otherOption}
                    onChange={(e) => setMultipleChoiceSettings({
                      ...multipleChoiceSettings,
                      otherOption: e.target.checked
                    })}
                  />
                </Box>
                <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1, marginTop: 2 }}>
                  <Button
                    variant="outlined"
                    size="small"
                    onClick={handleAddSubquestion}
                    sx={{
                      borderColor: '#d1d5db',
                      color: '#374151',
                      textTransform: 'none',
                      fontWeight: 500,
                      fontSize: '12px',
                      borderRadius: '6px',
                      '&:hover': {
                        borderColor: '#9ca3af',
                        backgroundColor: '#f9fafb'
                      }
                    }}
                  >
                    ADD SUBQUESTION
                  </Button>
                </Box>
              </Box>
            )}

            {selectedCard === 3 && !selectedSubquestion && (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5 }}>
                <TextField
                  fullWidth
                  placeholder="0 label"
                  size="small"
                  sx={{
                    '& .MuiOutlinedInput-root': {
                      color: '#111827',
                      backgroundColor: '#f9fafb',
                      fontSize: '12px',
                      '& fieldset': {
                        borderColor: '#e5e7eb'
                      },
                      '&:hover fieldset': {
                        borderColor: '#d1d5db'
                      },
                      '&.Mui-focused fieldset': {
                        borderColor: '#047857'
                      }
                    }
                  }}
                />
                <TextField
                  fullWidth
                  placeholder="5 label"
                  size="small"
                  sx={{
                    '& .MuiOutlinedInput-root': {
                      color: '#111827',
                      backgroundColor: '#f9fafb',
                      fontSize: '12px',
                      '& fieldset': {
                        borderColor: '#e5e7eb'
                      },
                      '&:hover fieldset': {
                        borderColor: '#d1d5db'
                      },
                      '&.Mui-focused fieldset': {
                        borderColor: '#047857'
                      }
                    }
                  }}
                />
                <TextField
                  fullWidth
                  placeholder="10 label"
                  size="small"
                  sx={{
                    '& .MuiOutlinedInput-root': {
                      color: '#111827',
                      backgroundColor: '#f9fafb',
                      fontSize: '12px',
                      '& fieldset': {
                        borderColor: '#e5e7eb'
                      },
                      '&:hover fieldset': {
                        borderColor: '#d1d5db'
                      },
                      '&.Mui-focused fieldset': {
                        borderColor: '#047857'
                      }
                    }
                  }}
                />
                <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1, marginTop: 2 }}>
                  <Button
                    variant="outlined"
                    size="small"
                    onClick={handleAddSubquestion3}
                    sx={{
                      borderColor: '#d1d5db',
                      color: '#374151',
                      textTransform: 'none',
                      fontWeight: 500,
                      fontSize: '12px',
                      borderRadius: '6px',
                      '&:hover': {
                        borderColor: '#9ca3af',
                        backgroundColor: '#f9fafb'
                      }
                    }}
                  >
                    ADD SUBQUESTION
                  </Button>
                </Box>
              </Box>
            )}

            {/* Subquestion Properties Panel */}
            {selectedSubquestion && (
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5, paddingTop: 2 }}>
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                  <SettingsIcon sx={{ fontSize: '20px', color: '#8c8c8c' }} />
                  <Typography variant="subtitle2" sx={{ fontWeight: 600, color: '#111827' }}>
                    QUESTION SETTINGS
                  </Typography>
                </Box>
                {(() => {
                  const subcomp = [...subcomponents, ...subcomponents3].find(s => s.id === selectedSubquestion);
                  const isInCard2 = subcomponents.some(s => s.id === selectedSubquestion);

                  if (subcomp?.type === 'Subquestion') {
                    return (
                      <Typography sx={{ fontSize: '12px', color: '#6b7280', fontStyle: 'italic' }}>
                        Select a component type to edit settings
                      </Typography>
                    );
                  }

                  return (
                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5 }}>
                      <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
                        <Typography sx={{ fontSize: '12px', color: '#374151', fontWeight: 600 }}>
                          Logic
                        </Typography>
                        <FormControl>
                          <RadioGroup
                            row
                            value={showConditionalLogic[selectedSubquestion] ? conditionalLogic[selectedSubquestion]?.action || 'show' : 'show'}
                            onChange={(e) => {
                              if (e.target.value) {
                                setShowConditionalLogic({
                                  ...showConditionalLogic,
                                  [selectedSubquestion]: true
                                });
                                setConditionalLogic({
                                  ...conditionalLogic,
                                  [selectedSubquestion]: {
                                    ...conditionalLogic[selectedSubquestion],
                                    action: e.target.value
                                  }
                                });
                              }
                            }}
                          >
                            <FormControlLabel value="show" control={<Radio size="small" />} label={<Typography sx={{ fontSize: '12px' }}>Show</Typography>} />
                            <FormControlLabel value="hide" control={<Radio size="small" />} label={<Typography sx={{ fontSize: '12px' }}>Hide</Typography>} />
                          </RadioGroup>
                        </FormControl>
                      </Box>
                      {conditionalLogic[selectedSubquestion]?.rules && conditionalLogic[selectedSubquestion].rules.length > 0 && (
                        <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5, marginTop: 1 }}>
                          {/* Additional rules */}
                          {conditionalLogic[selectedSubquestion].rules.map((rule, index) => (
                            <Box key={index} sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
                              {index > 0 && (
                                <>
                                  <Divider sx={{ margin: '8px 0' }} />
                                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                    <Select
                                      size="small"
                                      value={rule.operator || ''}
                                      onChange={(e) => {
                                        const newRules = [...conditionalLogic[selectedSubquestion].rules];
                                        newRules[index].operator = e.target.value;
                                        setConditionalLogic({
                                          ...conditionalLogic,
                                          [selectedSubquestion]: {
                                            ...conditionalLogic[selectedSubquestion],
                                            rules: newRules
                                          }
                                        });
                                      }}
                                      sx={{ width: '80px', fontSize: '12px' }}
                                      displayEmpty
                                    >
                                      <MenuItem value="">Select logic</MenuItem>
                                      <MenuItem value="and">and</MenuItem>
                                      <MenuItem value="or">or</MenuItem>
                                    </Select>
                                  </Box>
                                </>
                              )}
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                <Typography sx={{ fontSize: '12px', color: '#374151', fontWeight: 500, minWidth: 'auto' }}>
                                  If
                                </Typography>
                                <Select
                                  size="small"
                                  value={rule.condition1 || ''}
                                  onChange={(e) => {
                                    const newRules = [...conditionalLogic[selectedSubquestion].rules];
                                    newRules[index].condition1 = e.target.value;
                                    setConditionalLogic({
                                      ...conditionalLogic,
                                      [selectedSubquestion]: {
                                        ...conditionalLogic[selectedSubquestion],
                                        rules: newRules
                                      }
                                    });
                                  }}
                                  sx={{ flex: 1, fontSize: '12px' }}
                                  displayEmpty
                                >
                                  <MenuItem value="">Select field</MenuItem>
                                  <MenuItem value="option1">Option 1</MenuItem>
                                  <MenuItem value="option2">Option 2</MenuItem>
                                  <MenuItem value="option3">Option 3</MenuItem>
                                </Select>
                              </Box>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                <Select
                                  size="small"
                                  value={rule.condition2 || ''}
                                  onChange={(e) => {
                                    const newRules = [...conditionalLogic[selectedSubquestion].rules];
                                    newRules[index].condition2 = e.target.value;
                                    setConditionalLogic({
                                      ...conditionalLogic,
                                      [selectedSubquestion]: {
                                        ...conditionalLogic[selectedSubquestion],
                                        rules: newRules
                                      }
                                    });
                                  }}
                                  sx={{ flex: 1, fontSize: '12px' }}
                                  displayEmpty
                                >
                                  <MenuItem value="">Select operator</MenuItem>
                                  <MenuItem value="is">is</MenuItem>
                                  <MenuItem value="isNot">is not</MenuItem>
                                  <MenuItem value="empty">empty</MenuItem>
                                  <MenuItem value="contains">contains</MenuItem>
                                  <MenuItem value="doesNotContain">does not contain</MenuItem>
                                  <MenuItem value="startsWith">starts with</MenuItem>
                                  <MenuItem value="endsWith">ends with</MenuItem>
                                  <MenuItem value="greaterThan">greater than</MenuItem>
                                  <MenuItem value="lessThan">less than</MenuItem>
                                </Select>
                              </Box>
                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                <Select
                                  size="small"
                                  value={rule.condition3 || ''}
                                  onChange={(e) => {
                                    const newRules = [...conditionalLogic[selectedSubquestion].rules];
                                    newRules[index].condition3 = e.target.value;
                                    setConditionalLogic({
                                      ...conditionalLogic,
                                      [selectedSubquestion]: {
                                        ...conditionalLogic[selectedSubquestion],
                                        rules: newRules
                                      }
                                    });
                                  }}
                                  sx={{ flex: 1, fontSize: '12px' }}
                                  displayEmpty
                                >
                                  <MenuItem value="">Select value</MenuItem>
                                  <MenuItem value="value1">Selected</MenuItem>
                                  <MenuItem value="value2">Not selected</MenuItem>
                                </Select>
                              </Box>
                            </Box>
                          ))}
                        </Box>
                      )}
                      <Button
                        size="small"
                        startIcon={<AddIcon sx={{ fontSize: '16px' }} />}
                        onClick={() => {
                          setConditionalLogic({
                            ...conditionalLogic,
                            [selectedSubquestion]: {
                              ...conditionalLogic[selectedSubquestion],
                              rules: [
                                ...(conditionalLogic[selectedSubquestion]?.rules || []),
                                { operator: 'and', condition1: '', condition2: '', condition3: '' }
                              ]
                            }
                          });
                        }}
                        sx={{
                          textTransform: 'none',
                          color: '#6b7280',
                          fontSize: '12px',
                          fontWeight: 500,
                          padding: '6px 12px',
                          justifyContent: 'flex-start',
                          '&:hover': {
                            backgroundColor: 'rgba(4, 120, 87, 0.08)'
                          }
                        }}
                      >
                        Add new rule
                      </Button>
                    </Box>
                  );
                })()}
              </Box>
            )}
          </Box>
        </Box>
      };

      return <Card sx={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden', borderRadius: '12px', boxShadow: 1 }}>
        <BreadcrumbBar />
        <TabsRow />
        <MainContent />
      </Card>
    };

    return <>
      <Box className="root-container" onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp} >
        <TopNavbar />
        <Box className="content-container">
          <SideBar />
          <MainCard />
        </Box>
      </Box>

      <PreviewModal />
      <VersionHistoryModal />
      <ImportModal />
      <ExportModal />
      <PublishModal />
      <ConditionalLogicModal />
      <IAChat />
    </>
  };

  const FormsTable = () => {
    const dispatch = useDispatch();
    const { forms, loading } = useSelector(state => state.formEditor);
    const [paginationModel, setPaginationModel] = useState({ page: 0, pageSize: 10 });

    useEffect(() => {
      dispatch(fetchForms());
    }, [dispatch]);

    const columns = [
      {
        field: 'title',
        headerName: 'Form Title',
        flex: 1,
        minWidth: 200,
      },
      {
        field: 'description',
        headerName: 'Description',
        flex: 1,
        minWidth: 250,
      },
      {
        field: '$id',
        headerName: 'ID',
        width: 150,
      },
      {
        field: 'questions',
        headerName: 'Questions',
        width: 100,
        valueGetter: (params) => {
          return Object.keys(params.row.properties || {}).length;
        },
      },
      {
        field: 'required',
        headerName: 'Required Fields',
        width: 130,
        valueGetter: (params) => {
          return params.row.required?.length || 0;
        },
      },
      {
        field: 'actions',
        headerName: 'Actions',
        width: 200,
        sortable: false,
        renderCell: (params) => (
          <Box sx={{ display: 'flex', gap: 1 }}>
            <Button
              size="small"
              variant="outlined"
              startIcon={<EditIcon />}
              onClick={() => handleEditForm(params.row)}
            >
              Edit
            </Button>
            <Button
              size="small"
              variant="outlined"
              color="error"
              startIcon={<DeleteOutlineIcon />}
              onClick={() => handleDeleteForm(params.row.$id)}
            >
              Delete
            </Button>
          </Box>
        ),
      },
    ];

    const handleEditForm = (form) => {
      dispatch(setSelectedForm(form.$id));
    };

    const handleDeleteForm = async (formId) => {
      if (window.confirm('Are you sure you want to delete this form?')) {
        try {
          await dispatch(deleteForm(formId)).unwrap();
        } catch (error) {
          console.error('Failed to delete form:', error);
        }
      }
    };

    const handleCreateNew = () => {
      const newForm = {
        title: 'New Form',
        type: 'object',
        description: 'A new form',
        properties: {},
        required: []
      };
      dispatch(createForm(newForm));
    };

    return <>
      <Box className="root-container">
        <TopNavbar />
        <Box className="content-container">
          <SideBar />
          <Card sx={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden', borderRadius: '12px', boxShadow: 1 }}>
            <Box sx={{ flexGrow: 1, width: '100%', p: 3, display: 'flex', flexDirection: 'column' }}>
              <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 3 }}>
                <Typography variant="h4" component="h1">
                  All Forms
                </Typography>
              </Box>

              <Box sx={{ flexGrow: 1, width: '100%' }}>
                <DataGrid
                  rows={forms.results}
                  columns={columns}
                  loading={loading}
                  pageSizeOptions={[5, 10, 25, 50]}
                  paginationModel={paginationModel}
                  onPaginationModelChange={setPaginationModel}
                  getRowId={(row) => row.$id}
                  disableRowSelectionOnClick
                  sx={{
                    '& .MuiDataGrid-cell': {
                      borderBottom: '1px solid #e5e7eb',
                    },
                    '& .MuiDataGrid-columnHeaders': {
                      backgroundColor: '#f9fafb',
                      borderBottom: '2px solid #e5e7eb',
                    },
                  }}
                />
              </Box>
            </Box>
          </Card>
        </Box>
      </Box>
    </>;
  }

  return (<ThemeProvider theme={theme}>
    <CssBaseline />
    {selectedForm ||true ? <FormEditor /> : <FormsTable />}
  </ThemeProvider>);
}

export default App;

